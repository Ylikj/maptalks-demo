/*!
 * maptalks.windylayer v0.1.2
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
/*!
 * requires maptalks@^0.23.0
 */
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],n):n(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,n){"use strict";function e(t){var e=100,r=[NaN,NaN,null],a=(Math.pow(10,-5.2),function(t,n,e,r,a,o){var i=1-t,f=1-n,u=i*f,s=t*f,h=i*n,c=t*n,d=e[0]*u+r[0]*s+a[0]*h+o[0]*c,p=e[1]*u+r[1]*s+a[1]*h+o[1]*c;return[d,p,Math.sqrt(d*d+p*p)]}),o=function(t,n){var e=t.data,r=n.data;return{header:t.header,data:function(t){return[e[t],r[t]]},interpolate:a}},i=function(t){var n=null,e=null,r=null;return t.forEach(function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"2,2":n=t;break;case"2,3":e=t;break;default:r=t}}),o(n,e)},f=function(t,n){function e(t,n){var e,a=s(t-o,360)/h,i=(f-n)/c,d=Math.floor(a),p=d+1,l=Math.floor(i),g=l+1;if(e=y[l]){var v=e[d],w=e[p];if(u(v)&&u(w)&&(e=y[g])){var m=e[d],b=e[p];if(u(m)&&u(b))return r.interpolate(a-d,i-l,v,w,m,b)}}return null}var r=i(t),a=r.header,o=a.lo1,f=a.la1,h=a.dx,c=a.dy,d=a.nx,p=a.ny,l=new Date(a.refTime);l.setHours(l.getHours()+a.forecastTime);for(var y=[],g=0,v=Math.floor(d*h)>=360,w=0;w<p;w++){for(var m=[],b=0;b<d;b++,g++)m[b]=r.data(g);v&&m.push(m[0]),y[w]=m}n({date:l,interpolate:e})},u=function(t){return null!==t&&void 0!==t},s=function(t,n){return t-n*Math.floor(t/n)},h=function(){return/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)},c=function(t,n,e,r,a,o,i,f){var u=i[0]*o,s=i[1]*o,h=d(t,n,e,r,a,f);return i[0]=h[0]*u+h[2]*s,i[1]=h[1]*u+h[3]*s,i},d=function(t,n,e,r,a,o){var i=2*Math.PI,f=Math.pow(10,-5.2),u=n<0?f:-f,s=e<0?f:-f,h=m(e,n+u,o),c=m(e+s,n,o),d=Math.cos(e/360*i);return[(h[0]-r)/u/d,(h[1]-a)/u/d,(c[0]-r)/s,(c[1]-a)/s]},p=function(t,n,e){function a(n,e){var a=t[Math.round(n)];return a&&a[Math.round(e)]||r}a.release=function(){t=[]},a.randomize=function(t){var e,r,o=0;do{e=Math.round(Math.floor(Math.random()*n.width)+n.x),r=Math.round(Math.floor(Math.random()*n.height)+n.y)}while(null===a(e,r)[2]&&o++<30);return t.x=e,t.y=r,t},e(n,a)},l=function(t,n,e){var r=t[0],a=t[1],o=Math.round(r[0]),i=Math.max(Math.floor(r[1],0),0);Math.min(Math.ceil(a[0],n),n-1);return{x:o,y:i,xMax:n,yMax:Math.min(Math.ceil(a[1],e),e-1),width:n,height:e}},y=function(t){return t/180*Math.PI},g=function(t){return t/(Math.PI/180)},v=function(t,n,e){var r=e.east-e.west,a=e.width/g(r)*360/(2*Math.PI),o=a/2*Math.log((1+Math.sin(e.south))/(1-Math.sin(e.south))),i=e.height+o,f=(i-n)/a,u=180/Math.PI*(2*Math.atan(Math.exp(f))-Math.PI/2);return[g(e.west)+t/e.width*g(r),u]},w=function(t){return Math.log(Math.tan(t/2+Math.PI/4))},m=function(t,n,e){var r=w(e.south),a=w(e.north),o=e.width/(e.east-e.west),i=e.height/(a-r),f=w(y(t)),u=(y(n)-e.west)*o,f=(a-f)*i;return[u,f]},b=function(t,n,e,r){function a(r){for(var a=[],u=n.y;u<=n.yMax;u+=2){var s=v(r,u,e);if(s){var h=s[0],d=s[1];if(isFinite(h)){var p=t.interpolate(h,d);p&&(p=c(o,h,d,r,u,i,p,e),a[u+1]=a[u]=p)}}}f[r+1]=f[r]=a}var o={},i=.011,f=[],u=n.x;!function t(){for(var e=Date.now();u<n.width;)if(a(u),u+=2,Date.now()-e>1e3)return void setTimeout(t,25);p(f,n,r)}()},M=function(r,a){function o(t){return parseInt(u(t).substring(0,2),16)}function i(t){return parseInt(u(t).substring(2,4),16)}function f(t){return parseInt(u(t).substring(4,6),16)}function u(t){return"#"==t.charAt(0)?t.substring(1,7):t}function s(){p.forEach(function(t){t.length=0}),y.forEach(function(t){t.age>e&&(a.randomize(t).age=0);var n=t.x,r=t.y,o=a(n,r),i=o[2];if(null===i)t.age=e;else{var f=n+o[0],u=r+o[1];null!==a(f,u)[2]?(t.xt=f,t.yt=u,p[d.indexFor(i)].push(t)):(t.x=f,t.y=u)}t.age+=1})}function c(){var t=v.globalCompositeOperation;v.globalCompositeOperation="destination-in",v.fillRect(r.x,r.y,r.width,r.height),v.globalCompositeOperation=t,p.forEach(function(t,n){t.length>0&&(v.beginPath(),v.strokeStyle=d[n],t.forEach(function(t){v.moveTo(t.x,t.y),v.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt}),v.stroke())})}var d=function(t,n){var e=["rgba("+o("#00ffff")+", "+i("#00ffff")+", "+f("#00ffff")+", 0.5)","rgba("+o("#64f0ff")+", "+i("#64f0ff")+", "+f("#64f0ff")+", 0.5)","rgba("+o("#87e1ff")+", "+i("#87e1ff")+", "+f("#87e1ff")+", 0.5)","rgba("+o("#a0d0ff")+", "+i("#a0d0ff")+", "+f("#a0d0ff")+", 0.5)","rgba("+o("#b5c0ff")+", "+i("#b5c0ff")+", "+f("#b5c0ff")+", 0.5)","rgba("+o("#c6adff")+", "+i("#c6adff")+", "+f("#c6adff")+", 0.5)","rgba("+o("#d49bff")+", "+i("#d49bff")+", "+f("#d49bff")+", 0.5)","rgba("+o("#e185ff")+", "+i("#e185ff")+", "+f("#e185ff")+", 0.5)","rgba("+o("#ec6dff")+", "+i("#ec6dff")+", "+f("#ec6dff")+", 0.5)","rgba("+o("#ff1edb")+", "+i("#ff1edb")+", "+f("#ff1edb")+", 0.5)"];return e.indexFor=function(t){return Math.floor(Math.min(t,n)/n*(e.length-1))},e}(10,40),p=d.map(function(){return[]}),l=Math.round(r.width*r.height*(1/30));h()&&(l*=.75);for(var y=[],g=0;g<l;g++)y.push(a.randomize({age:Math.floor(Math.random()*e)+0}));var v=t.canvas.getContext("2d");v.lineWidth=.8,v.fillStyle="rgba(0, 0, 0, 0.97)",function e(){s(),c(),t.onDraw(),O.timer=n.Util.requestAnimFrame(e)}()},x=function(n,e,r,a){var o={south:y(a[0][1]),north:y(a[1][1]),east:y(a[1][0]),west:y(a[0][0]),width:e,height:r};_(),f(t.data,function(t){b(t,l(n,e,r),o,function(t,n){O.field=n,M(t,n)})})},_=function(){O.field&&O.field.release(),O.timer&&n.Util.cancelAnimFrame(O.timer)},O={params:t,start:x,stop:_};return O}function r(t,n){for(var e=Object.getOwnPropertyNames(n),r=0;r<e.length;r++){var a=e[r],o=Object.getOwnPropertyDescriptor(n,a);o&&o.configurable&&void 0===t[a]&&Object.defineProperty(t,a,o)}return t}function a(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function o(t,n){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?t:n}function i(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(t,n):r(t,n))}var f=function(t){function n(e,r,i){a(this,n);var f=o(this,t.call(this,e,i));return f._data=r,f}return i(n,t),n.prototype.getData=function(){return this._data},n.prototype.setData=function(t){return this._data=t,this.redraw(),this},n.prototype.redraw=function(){return this._getRenderer()&&this._getRenderer()._redraw(),this},n.prototype.toJSON=function(){return{type:"WindyLayer",id:this.getId(),options:this.config(),data:this.getData()}},n.fromJSON=function(t){return t&&"WindyLayer"===t.type?new n(t.id,t.data,t.options):null},n}(n.Layer);f.registerRenderer("canvas",function(t){function n(){return a(this,n),o(this,t.apply(this,arguments))}return i(n,t),n.prototype.draw=function(){var t=this;this.canvas?(this.prepareCanvas(),this._windy.start.apply(this._windy,this._getWindExtents())):(this.prepareCanvas(),this._windy=new e({canvas:this.canvas,data:this.layer.getData(),onDraw:function(){t.setCanvasUpdated()}}),this._windy.start.apply(this._windy,this._getWindExtents()))},n.prototype.drawOnInteracting=function(){},n.prototype._getWindExtents=function(){var t=this.getMap(),n=t.getExtent();return[[[0,0],[t.width,t.height]],t.width,t.height,[[n.xmin,n.ymin],[n.xmax,n.ymax]]]},n.prototype._redraw=function(){this.prepareRender(),this.draw()},n.prototype.onRemove=function(){this._windy.stop(),delete this._windy},n.prototype.onDragRotateStart=function(){this._windy.stop()},n.prototype.onMoveStart=function(){this._windy.stop()},n.prototype.onZoomStart=function(){this._windy.stop()},n.prototype.onZoomEnd=function(n){t.prototype.onZoomEnd.call(this,n)},n}(n.renderer.CanvasRenderer)),t.WindyLayer=f,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.windylayer v0.1.2, requires maptalks@^0.23.0.")});