!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("three")):"function"==typeof define&&define.amd?define(["exports","maptalks","three"],e):e(t.maptalks=t.maptalks||{},t.maptalks,t.THREE)}(this,function(t,ut,ht){"use strict";var e,n,r="object"==typeof t&&"undefined"!=typeof module,ut=ut;function i(t,e){t.prototype=Object.create(e.prototype),(t.prototype.constructor=t).__proto__=e}r&&(ut=ut||require("maptalks")),n=function(t){var w=n,e=n;function n(t,e,n){n=n||2;var r,i,o,a,s,c,u,h=e&&e.length,l=h?e[0]*n:t.length,f=p(t,0,l,n,!0),d=[];if(!f||f.next===f.prev)return d;if(h&&(f=function(t,e,n,r){var i,o,a,s,c,u=[];for(i=0,o=e.length;i<o;i++)a=e[i]*r,s=i<o-1?e[i+1]*r:t.length,(c=p(t,a,s,r,!1))===c.next&&(c.steiner=!0),u.push(function(t){var e=t,n=t;for(;(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next,e!==t;);return n}(c));for(u.sort(y),i=0;i<u.length;i++)!function(t,e){{var n;(e=function(t,e){var n,r=e,i=t.x,o=t.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var s=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=i&&a<s){if((a=s)===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==e);if(!n)return null;if(i===a)return n;var c,u=n,h=n.x,l=n.y,f=1/0;r=n;for(;i>=r.x&&r.x>=h&&i!==r.x&&b(o<l?i:a,o,h,l,o<l?a:i,o,r.x,r.y)&&(c=Math.abs(o-r.y)/(i-r.x),M(r,t)&&(c<f||c===f&&(r.x>n.x||r.x===n.x&&function(t,e){return _(t.prev,t,e.prev)<0&&_(e.next,t,t.next)<0}(n,r)))&&(n=r,f=c)),r=r.next,r!==u;);return n}(t,e))&&(n=j(e,t),g(e,e.next),g(n,n.next))}}(u[i],n),n=g(n,n.next);return n}(t,e,f,n)),t.length>80*n){r=o=t[0],i=a=t[1];for(var v=n;v<l;v+=n)(s=t[v])<r&&(r=s),(c=t[v+1])<i&&(i=c),o<s&&(o=s),a<c&&(a=c);u=0!==(u=Math.max(o-r,a-i))?1/u:0}return x(f,d,n,r,i,u),d}function p(t,e,n,r,i){var o,a;if(i===0<O(t,e,n,r))for(o=e;o<n;o+=r)a=s(o,t[o],t[o+1],a);else for(o=n-r;e<=o;o-=r)a=s(o,t[o],t[o+1],a);return a&&h(a,a.next)&&(f(a),a=a.next),a}function g(t,e){if(!t)return t;e=e||t;var n,r=t;do{if(n=!1,r.steiner||!h(r,r.next)&&0!==_(r.prev,r,r.next))r=r.next;else{if(f(r),(r=e=r.prev)===r.next)break;n=!0}}while(n||r!==e);return e}function x(t,e,n,r,i,o,a){if(t){!a&&o&&function(t,e,n,r){var i=t;for(;null===i.z&&(i.z=m(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next,i!==t;);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,n,r,i,o,a,s,c,u=1;do{for(n=t,o=t=null,a=0;n;){for(a++,r=n,e=s=0;e<u&&(s++,r=r.nextZ);e++);for(c=u;0<s||0<c&&r;)0!==s&&(0===c||!r||n.z<=r.z)?(n=(i=n).nextZ,s--):(r=(i=r).nextZ,c--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;n=r}o.nextZ=null,u*=2}while(1<a)}(i)}(t,r,i,o);for(var s,c,u=t;t.prev!==t.next;)if(s=t.prev,c=t.next,o?function(t,e,n,r){var i=t.prev,o=t,a=t.next;if(0<=_(i,o,a))return!1;var s=i.x<o.x?i.x<a.x?i.x:a.x:o.x<a.x?o.x:a.x,c=i.y<o.y?i.y<a.y?i.y:a.y:o.y<a.y?o.y:a.y,u=i.x>o.x?i.x>a.x?i.x:a.x:o.x>a.x?o.x:a.x,h=i.y>o.y?i.y>a.y?i.y:a.y:o.y>a.y?o.y:a.y,l=m(s,c,e,n,r),f=m(u,h,e,n,r),d=t.prevZ,v=t.nextZ;for(;d&&d.z>=l&&v&&v.z<=f;){if(d!==t.prev&&d!==t.next&&b(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=_(d.prev,d,d.next))return!1;if(d=d.prevZ,v!==t.prev&&v!==t.next&&b(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&0<=_(v.prev,v,v.next))return!1;v=v.nextZ}for(;d&&d.z>=l;){if(d!==t.prev&&d!==t.next&&b(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=_(d.prev,d,d.next))return!1;d=d.prevZ}for(;v&&v.z<=f;){if(v!==t.prev&&v!==t.next&&b(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&0<=_(v.prev,v,v.next))return!1;v=v.nextZ}return!0}(t,r,i,o):function(t){var e=t.prev,n=t,r=t.next;if(0<=_(e,n,r))return!1;var i=t.next.next;for(;i!==t.prev;){if(b(e.x,e.y,n.x,n.y,r.x,r.y,i.x,i.y)&&0<=_(i.prev,i,i.next))return!1;i=i.next}return!0}(t))e.push(s.i/n),e.push(t.i/n),e.push(c.i/n),f(t),t=c.next,u=c.next;else if((t=c)===u){a?1===a?x(t=function(t,e,n){var r=t;do{var i=r.prev,o=r.next.next;!h(i,o)&&l(i,r,r.next,o)&&M(i,o)&&M(o,i)&&(e.push(i.i/n),e.push(r.i/n),e.push(o.i/n),f(r),f(r.next),r=t=o),r=r.next}while(r!==t);return g(r)}(g(t),e,n),e,n,r,i,o,2):2===a&&function(t,e,n,r,i,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&function(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&l(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(M(t,e)&&M(e,t)&&function(t,e){var n=t,r=!1,i=(t.x+e.x)/2,o=(t.y+e.y)/2;for(;n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next,n!==t;);return r}(t,e)&&(_(t.prev,t,e.prev)||_(t,e.prev,e))||h(t,e)&&0<_(t.prev,t,t.next)&&0<_(e.prev,e,e.next))}(a,s)){var c=j(a,s);return a=g(a,a.next),c=g(c,c.next),x(a,e,n,r,i,o),x(c,e,n,r,i,o)}s=s.next}a=a.next}while(a!==t)}(t,e,n,r,i,o):x(g(t),e,n,r,i,o,1);break}}}function y(t,e){return t.x-e.x}function m(t,e,n,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*i)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*i)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function b(t,e,n,r,i,o,a,s){return 0<=(i-a)*(e-s)-(t-a)*(o-s)&&0<=(t-a)*(r-s)-(n-a)*(e-s)&&0<=(n-a)*(o-s)-(i-a)*(r-s)}function _(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function h(t,e){return t.x===e.x&&t.y===e.y}function l(t,e,n,r){var i=u(_(t,e,n)),o=u(_(t,e,r)),a=u(_(n,r,t)),s=u(_(n,r,e));return i!==o&&a!==s||(0===i&&c(t,n,e)||(0===o&&c(t,r,e)||(0===a&&c(n,t,r)||!(0!==s||!c(n,e,r)))))}function c(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function u(t){return 0<t?1:t<0?-1:0}function M(t,e){return _(t.prev,t,t.next)<0?0<=_(t,e,t.next)&&0<=_(t,t.prev,e):_(t,e,t.prev)<0||_(t,t.next,e)<0}function j(t,e){var n=new a(t.i,t.x,t.y),r=new a(e.i,e.x,e.y),i=t.next,o=e.prev;return(t.next=e).prev=t,(n.next=i).prev=n,(r.next=n).prev=r,(o.next=r).prev=o,r}function s(t,e,n,r){var i=new a(t,e,n);return r?(i.next=r.next,(i.prev=r).next.prev=i,r.next=i):(i.prev=i).next=i,i}function f(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function a(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function O(t,e,n,r){for(var i=0,o=e,a=n-r;o<n;o+=r)i+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return i}function i(t,e){var n=t.length-1,r=[t[0]];return function t(e,n,r,i,o){for(var a,s,c,u,h,l,f,d,v,p=i,g=n+1;g<r;g++){var x=(s=e[g],c=e[n],u=e[r],v=d=f=l=h=void 0,l=c[0],f=c[1],d=u[0]-l,v=u[1]-f,0===d&&0===v||(1<(h=((s[0]-l)*d+(s[1]-f)*v)/(d*d+v*v))?(l=u[0],f=u[1]):0<h&&(l+=d*h,f+=v*h)),(d=s[0]-l)*d+(v=s[1]-f)*v);p<x&&(a=g,p=x)}i<p&&(1<a-n&&t(e,n,a,i,o),o.push(e[a]),1<r-a&&t(e,a,r,i,o))}(t,0,n,e,r),r.push(t[n]),r}function S(t,e,n){if(t.length<=2)return t;var r=void 0!==e?e*e:1;return t=i(t=n?t:function(t,e){for(var n,r,i,o,a,s=t[0],c=[s],u=1,h=t.length;u<h;u++)n=t[u],i=s,a=o=void 0,o=(r=n)[0]-i[0],a=r[1]-i[1],e<o*o+a*a&&(c.push(n),s=n);return s!==n&&c.push(n),c}(t,r),r)}function I(t,e){var n=e[0],r=e[1],i=Math.sqrt(n*n+r*r);return t[0]=n/i,t[1]=r/i,t}function A(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t}function z(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}n.deviation=function(t,e,n,r){var i=e&&e.length,o=i?e[0]*n:t.length,a=Math.abs(O(t,0,o,n));if(i)for(var s=0,c=e.length;s<c;s++){var u=e[s]*n,h=s<c-1?e[s+1]*n:t.length;a-=Math.abs(O(t,u,h,n))}for(var l=0,s=0;s<r.length;s+=3){var f=r[s]*n,d=r[s+1]*n,v=r[s+2]*n;l+=Math.abs((t[f]-t[v])*(t[1+d]-t[1+f])-(t[f]-t[d])*(t[1+v]-t[1+f]))}return 0===a&&0===l?0:Math.abs((l-a)/a)},n.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var o=0;o<t[i].length;o++)for(var a=0;a<e;a++)n.vertices.push(t[i][o][a]);0<i&&(r+=t[i-1].length,n.holes.push(r))}return n},w.default=e;var C=[];function ht(t,e,n,r){var i,o,a,s,c,u,h,l,f,d,v,p=(o=n,(i=e)[0]*o[0]+i[1]*o[1]+i[2]*o[2]),g=Math.acos(p)*r;return A(C,n,e,-p),c=(s=a=C)[0],u=s[1],h=s[2],l=Math.sqrt(c*c+u*u+h*h),a[0]=c/l,a[1]=u/l,a[2]=h/l,f=t,d=e,v=Math.cos(g),f[0]=d[0]*v,f[1]=d[1]*v,f[2]=d[2]*v,A(t,t,C,Math.sin(g)),t}function T(t,e,n){if(n-e<3)return 0;for(var r=0,i=2*(n-1),o=2*e;o<2*n;){var a=t[i],s=t[i+1],c=t[o],u=t[o+1],i=o;o+=2,r+=a*u-c*s}return r}var P=[],L=[],V=[];function k(t,e,n,r,i,o,a,s){var c=null!=a,u=i,h=null;c&&(h=new Uint32Array(r-n));for(var l,f,d,v,p,g=n;g<r;g++){var x,y,m,b,_,w,M,j,O=g===r-1?n:g+1,S=g===n?r-1:g-1,A=t[2*S],C=t[2*S+1],T=t[2*g],k=t[2*g+1],B=t[2*O],z=t[2*O+1];P[0]=T-A,P[1]=k-C,L[0]=B-T,L[1]=z-k,I(P,P),I(L,L),c&&(h[g]=u),s||g!==n?s||g!==r-1?(v=L,p=P,(d=V)[0]=v[0]+p[0],d[1]=v[1]+p[1],x=V[1],V[1]=-V[0],V[0]=x,I(V,V),f=L,y=(l=V)[0]*f[0]+l[1]*f[1],m=Math.sqrt(1-y*y),b=o*Math.min(10,1/m),c&&a<1/m&&o*y<0?(_=T+V[0]*o,w=k+V[1]*o,M=Math.acos(m)/2,j=Math.tan(M)*Math.abs(o),e[2*u]=_+V[1]*j,e[2*u+1]=w-V[0]*j,e[2*++u]=_-V[1]*j,e[2*u+1]=w+V[0]*j):(e[2*u]=T+V[0]*b,e[2*u+1]=k+V[1]*b)):(V[0]=P[1],V[1]=-P[0],I(V,V),e[2*u]=T+V[0]*o,e[2*u+1]=k+V[1]*o):(V[0]=L[1],V[1]=-L[0],I(V,V),e[2*u]=T+V[0]*o,e[2*u+1]=k+V[1]*o),u++}return h}function B(t,e,n,r){for(var i=0;i<Math.floor((r-n)/2);i++)for(var o=0;o<e;o++){var a=(i+n)*e+o,s=(r-i-1)*e+o,c=t[a];t[a]=t[s],t[s]=c}return t}function E(t,e){function n(t,e,n,r){t[0]=e,t[1]=n,t[2]=r}for(var r,i,o,a,s,c,u,h,l,f=[],d=[],v=[],p=[],g=[],x=[],y=t.length,m=new Float32Array(e.length),b=0;b<y;){var _=3*t[b++],w=3*t[b++],M=3*t[b++];n(f,e[_],e[1+_],e[2+_]),n(d,e[w],e[1+w],e[2+w]),n(v,e[M],e[1+M],e[2+M]),z(p,f,d),z(g,d,v),r=x,o=g,l=h=u=c=s=a=void 0,a=(i=p)[0],s=i[1],c=i[2],u=o[0],h=o[1],l=o[2],r[0]=s*l-c*h,r[1]=c*u-a*l,r[2]=a*h-s*u;for(var j=0;j<3;j++)m[_+j]=m[_+j]+x[j],m[w+j]=m[w+j]+x[j],m[M+j]=m[M+j]+x[j]}for(var O,S,A,C,T,k,B=0;B<m.length;)n(x,m[B],m[B+1],m[B+2]),k=T=C=A=void 0,A=(S=O=x)[0],C=S[1],T=S[2],k=Math.sqrt(A*A+C*C+T*T),O[0]=A/k,O[1]=C/k,O[2]=T/k,m[B++]=x[0],m[B++]=x[1],m[B++]=x[2];return m}var lt=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function U(t,e,n,r,i,o){var a=e.vertices,s=e.topVertices,c=e.depth,u=e.rect,h=r-n,l=o.smoothSide?1:2,f=h*l,d=o.smoothBevel?1:2,v=Math.min(c/2,o.bevelSize),p=o.bevelSegments,g=i.vertex,x=Math.max(u.width,u.height);if(0<v)for(var y=[0,0,1],m=[],b=[0,0,-1],_=[],w=0,M=new Float32Array(h),j=0;j<2;j++)for(var O=0===j?c-v:v,S=0;S<=p*d;S++){for(var A=0,C=void 0,T=void 0,k=0;k<h;k++){for(var B=0;B<l;B++){var z=2*((k+B)%h+n);m[0]=a[z]-s[z],m[1]=a[1+z]-s[1+z],m[2]=0;var I=Math.sqrt(m[0]*m[0]+m[1]*m[1]);m[0]/=I,m[1]/=I;var P=(Math.floor(S/d)+S%d)/p;0===j?ht(_,y,m,P):ht(_,m,b,P);var L,V,E,U,R=0===j?P:1-P,F=v*Math.sin(R*Math.PI/2),Z=I*Math.cos(R*Math.PI/2),G=v*I/Math.sqrt(F*F+Z*Z),D=_[0]*G+s[z],W=_[1]*G+s[1+z],H=_[2]*G+O;t.position[3*i.vertex]=D,t.position[3*i.vertex+1]=W,t.position[3*i.vertex+2]=H,(0<k||0<B)&&(A+=Math.sqrt((C-D)*(C-D)+(T-W)*(T-W))),(0<S||0<j)&&(L=3*(i.vertex-f),V=t.position[L],E=t.position[1+L],U=t.position[2+L],M[k]+=Math.sqrt((V-D)*(V-D)+(E-W)*(E-W)+(U-H)*(U-H))),t.uv[2*i.vertex]=A/x,t.uv[2*i.vertex+1]=M[k]/x,C=D,T=W,i.vertex++}if(1<d&&S%d||1==d&&1<=S)for(var q=0;q<6;q++){var K=(lt[q][0]+k*l)%f,N=lt[q][1]+w;t.indices[i.index++]=(N-1)*f+K+g}}w++}else for(var Q=0;Q<2;Q++)for(var X=0===Q?c-v:v,Y=0,J=void 0,$=void 0,tt=0;tt<h;tt++)for(var et=0;et<l;et++){var nt=2*((tt+et)%h+n),rt=a[nt],it=a[1+nt];t.position[3*i.vertex]=rt,t.position[3*i.vertex+1]=it,t.position[3*i.vertex+2]=X,(0<tt||0<et)&&(Y+=Math.sqrt((J-rt)*(J-rt)+($-it)*($-it))),t.uv[2*i.vertex]=Y/x,t.uv[2*i.vertex+1]=X/x,J=rt,$=it,i.vertex++}for(var ot=0<v?p*d+1:1,at=0;at<h;at++)for(var st=0;st<6;st++){var ct=(lt[st][0]+at*l)%f,ut=lt[st][1]+ot;t.indices[i.index++]=(ut-1)*f+ct+g}}function R(t,e){for(var n=0,r=0,i=0;i<t.length;i++){var o=t[i],a=o.indices,s=o.vertices,c=o.holes,u=o.depth,h=s.length/2,l=0<Math.min(u/2,e.bevelSize)?e.bevelSegments:0;n+=a.length*(e.excludeBottom?1:2),r+=h*(e.excludeBottom?1:2);for(var f=2+2*l,d=0,v=0,p=0;p<(c?c.length:0)+1;p++){n+=6*((v=0===p?c&&c.length?c[0]:h:(d=c[p-1],c[p]||h))-d)*(f-1);var g=(v-d)*(e.smoothSide?1:2);r+=g*f+(e.smoothBevel?0:l*g*2)}}for(var x={position:new Float32Array(3*r),indices:new(65535<r?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*r)},y={vertex:0,index:0},m=0;m<t.length;m++)!function(t,e,n,r){var i=t.indices,o=t.vertices,a=t.topVertices,s=t.rect,c=t.depth;if(!(o.length<=4)){for(var u=n.vertex,h=i.length,l=0;l<h;l++)e.indices[n.index++]=u+i[l];for(var f=Math.max(s.width,s.height),d=0;d<(r.excludeBottom?1:2);d++)for(var v=0;v<a.length;v+=2){var p=a[v],g=a[v+1];e.position[3*n.vertex]=p,e.position[3*n.vertex+1]=g,e.position[3*n.vertex+2]=(1-d)*c,e.uv[2*n.vertex]=(p-s.x)/f,e.uv[2*n.vertex+1]=(g-s.y)/f,n.vertex++}if(!r.excludeBottom)for(var x=o.length/2,y=0;y<h;y+=3)for(var m=0;m<3;m++)e.indices[n.index++]=u+x+i[y+2-m]}}(t[m],x,y,e);for(var b=0;b<t.length;b++){var _,w=t[b],M=w.holes,j=w.vertices.length/2,O=M&&M.length?M[0]:j;if(U(x,t[b],0,O,y,e),M)for(var S=0;S<M.length;S++)_=M[S],O=M[S+1]||j,U(x,t[b],_,O,y,e)}for(var A=0;A<x.uv.length;A++){var C=x.uv[A];0<C&&Math.round(C)===C?x.uv[A]=1:x.uv[A]=C%1}return x.normal=E(x.indices,x.position),x.boundingRect=t[0]&&t[0].rect,x}function F(t,e){e=Object.assign({},e);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<t.length;i++)!function(t,e,n){for(var r=0;r<t.length;r++)e[0]=Math.min(t[r][0],e[0]),e[1]=Math.min(t[r][1],e[1]),n[0]=Math.max(t[r][0],n[0]),n[1]=Math.max(t[r][1],n[1])}(t[i][0],n,r);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},function(t){t.depth=t.depth||1,t.bevelSize=t.bevelSize||0,t.bevelSegments=null==t.bevelSegments?2:t.bevelSegments,t.smoothSide=t.smoothSide||!1,t.smoothBevel=t.smoothBevel||!1,t.simplify=t.simplify||0,"number"==typeof t.depth&&(t.bevelSize=Math.min(0<t.bevelSegments?t.bevelSize:0,t.depth/2)),0<t.bevelSize||(t.bevelSegments=0),t.bevelSegments=Math.round(t.bevelSegments);var e,n,r,i,o=t.boundingRect;t.translate=t.translate||[0,0],t.scale=t.scale||[1,1],t.fitRect&&(e=null==t.fitRect.x?o.x||0:t.fitRect.x,n=null==t.fitRect.y?o.y||0:t.fitRect.y,r=t.fitRect.width,i=t.fitRect.height,null==r?null!=i?r=i/o.height*o.width:(r=o.width,i=o.height):null==i&&(i=r/o.width*o.height),t.scale=[r/o.width,i/o.height],t.translate=[(e-o.x)*t.scale[0],(n-o.y)*t.scale[1]])}(e);for(var o,a=[],s=e.translate||[0,0],c=e.scale||[1,1],u=e.boundingRect,h={x:u.x*c[0]+s[0],y:u.y*c[1]+s[1],width:u.width*c[0],height:u.height*c[1]},l=Math.min(u.width,u.height)/1e5,f=0;f<t.length;f++){var d=function(t,e){for(var n=[],r=0;r<t.length;r++){for(var i=t[r],o=[],a=i.length,s=i[a-1][0],c=i[a-1][1],u=0,h=0;h<a;h++){var l=i[h][0],f=i[h][1],d=l-s,v=f-c;e<(u+=Math.sqrt(d*d+v*v))&&(o.push(i[h]),u=0),s=l,c=f}3<=o.length&&n.push(o)}return 0<n.length?n:null}(t[f],l);if(d){var v=e.simplify/Math.max(c[0],c[1]);if(0<v&&(d=function(t,e){for(var n=[],r=0;r<t.length;r++){var i=t[r];3<=(i=S(i,e,!0)).length&&n.push(i)}return 0<n.length?n:null}(d,v)),d){for(var p=w.flatten(d),g=p.vertices,x=p.holes,y=p.dimensions,m=0;m<g.length;)g[m]=g[m++]*c[0]+s[0],g[m]=g[m++]*c[1]+s[1];if(!function(t,e){var n=t.length/2,r=0,i=e&&e.length?e[0]:n;0<T(t,r,i)&&B(t,2,r,i);for(var o=1;o<(e?e.length:0)+1;o++)T(t,r=e[o-1],i=e[o]||n)<0&&B(t,2,r,i)}(g,x),2!==y)throw new Error("Only 2D polygon points are supported");var b=0<e.bevelSize?function(t,e,n,r,i){var o=null!=r?[]:new Float32Array(t.length);if(k(t,o,0,e&&e.length?e[0]:t.length/2,0,n,r,i),e)for(var a=0;a<e.length;a++){var s=e[a];k(t,o,s,e[a+1]||t.length/2,null!=r?o.length/2:s,n,r,i)}return o}(g,x,e.bevelSize,null,!0):g,_=(void 0===(o=y)&&(o=2),w(b,x,o));a.push({indices:_,vertices:g,topVertices:b,holes:x,rect:h,depth:"function"==typeof e.depth?e.depth(f):e.depth})}}}return R(a,e)}t.initialize=function(){},t.onmessage=function(t,e){var n,r=t.data,i=r.type,o=r.datas;"Polygon"===i&&(function(t){for(var e=t.length,n=0;n<e;n++)for(var r=t[n].data,i=0,o=r.length;i<o;i++)for(var a=r[i],s=0,c=a.length;s<c;s++)t[n].data[i][s]=function(t){for(var e=new Float32Array(t),n=[],r=0,i=e.length;r<i;r+=2){var o=e[r],a=e[r+1];n.push([o,a])}return n}(a[s])}(o),e(null,n=function(t){for(var e=t.length,n=[],r=[],i=[],o=0,a=0,s=0,c=0,u=0;u<e;u++){var h=function(t){var e=t.data,n=t.height,r=F(e,{depth:n}),i=r.position,o=r.normal,a=r.uv,s=r.indices;return{position:i,normal:o,uv:a,indices:s}}(t[u]),l=h.position,f=h.normal,d=h.uv,v=h.indices;r.push(h);var p=v.length/3;i[u]=[o+1,o+p],o+=p;var g=l.length/3,x=f.length/3,y=d.length/2;n[u]={position:{count:g,start:a,end:a+3*g},normal:{count:x,start:s,end:s+3*x},uv:{count:y,start:c,end:c+2*y},hide:!1},a+=3*g,s+=3*x,c+=2*y}var m=function(t){for(var e={},n=0;n<t.length;++n){var r=t[n];for(var i in r)void 0===e[i]&&(e[i]=[]),e[i].push(r[i])}var o={},a=0,s=[];for(var c in e)if("indices"===c)for(var u=e[c],h=0,l=u.length;h<l;h++){for(var f=u[h],d=0,v=f.length;d<v;d++)s.push(f[d]+a);a+=e.position[h].length/3}else{var p=function(t){for(var e=0,n=0;n<t.length;++n){var r=t[n];e+=r.length}for(var i=new Float32Array(e),o=0,a=0;a<t.length;++a)i.set(t[a],o),o+=t[a].length;return i}(e[c]);if(!p)return null;o[c]=p}return o.indices=new Uint32Array(s),o}(r),b=m.position,_=m.normal,w=m.uv,M=m.indices;return{position:b.buffer,normal:_.buffer,uv:w.buffer,indices:M.buffer,faceMap:i,geometriesAttributes:n}}(o),[n.position,n.normal,n.uv,n.indices]))},Object.defineProperty(t,"__esModule",{value:!0})},e?n(r?module.exports:ut,ut):ut&&ut.registerWorkerAdapter?(ut.registerWorkerAdapter("maptalks.three",n),e=!0):console.warn("maptalks.registerWorkerAdapter is not defined,If you need to use ThreeVectorTileLayer,you can npm i maptalks@next,more https://github.com/maptalks/maptalks.js/tree/next");var o=function(t){function e(){return t.apply(this,arguments)||this}return i(e,t),e.prototype.addTo=function(t){if(t instanceof p)return t.on("mousemove",this.onMouseMove,this),t.on("mouseout",this.onMouseOut,this),this._owner=t,this._switchEvents("on"),this.onAdd&&this.onAdd(),this.fire("add"),this;throw new Error("Invalid BaseObject the tooltip is added to.")},e}(ut.ui.ToolTip),b=parseInt(ht.REVISION);function lt(t,e,n){return 109<b?t.setAttribute(e,n):t.addAttribute(e,n),t}function a(){ht.InstancedBufferGeometry.call(this),this.type="LineSegmentsGeometry",this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),lt(this,"position",new ht.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),lt(this,"uv",new ht.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}var s,c;a.prototype=Object.assign(Object.create(ht.InstancedBufferGeometry.prototype),{constructor:a,isLineSegmentsGeometry:!0,applyMatrix:function(t){var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==e&&(t.applyToBufferAttribute(e),t.applyToBufferAttribute(n),e.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},setPositions:function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new ht.InstancedInterleavedBuffer(e,6,1);return lt(this,"instanceStart",new ht.InterleavedBufferAttribute(n,3,0)),lt(this,"instanceEnd",new ht.InterleavedBufferAttribute(n,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this},setColors:function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new ht.InstancedInterleavedBuffer(e,6,1);return lt(this,"instanceColorStart",new ht.InterleavedBufferAttribute(n,3,0)),lt(this,"instanceColorEnd",new ht.InterleavedBufferAttribute(n,3,3)),this},fromWireframeGeometry:function(t){return this.setPositions(t.attributes.position.array),this},fromEdgesGeometry:function(t){return this.setPositions(t.attributes.position.array),this},fromMesh:function(t){return this.fromWireframeGeometry(new ht.WireframeGeometry(t.geometry)),this},fromLineSegements:function(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this},computeBoundingBox:(c=new ht.Box3,function(){null===this.boundingBox&&(this.boundingBox=new ht.Box3);var t=this.attributes.instanceStart,e=this.attributes.instanceEnd;void 0!==t&&void 0!==e&&(this.boundingBox.setFromBufferAttribute(t),c.setFromBufferAttribute(e),this.boundingBox.union(c))}),computeBoundingSphere:(s=new ht.Vector3,function(){null===this.boundingSphere&&(this.boundingSphere=new ht.Sphere),null===this.boundingBox&&this.computeBoundingBox();var t=this.attributes.instanceStart,e=this.attributes.instanceEnd;if(void 0!==t&&void 0!==e){var n=this.boundingSphere.center;this.boundingBox.getCenter(n);for(var r=0,i=0,o=t.count;i<o;i++)s.fromBufferAttribute(t,i),r=Math.max(r,n.distanceToSquared(s)),s.fromBufferAttribute(e,i),r=Math.max(r,n.distanceToSquared(s));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}),toJSON:function(){},copy:function(){return this}});var u={},h={};u.line={linewidth:{value:1},resolution:{value:new ht.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},h.line={uniforms:ht.UniformsUtils.merge([ht.UniformsLib.common,ht.UniformsLib.fog,u.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"};function g(t){ht.ShaderMaterial.call(this,{type:"LineMaterial",uniforms:ht.UniformsUtils.clone(h.line.uniforms),vertexShader:h.line.vertexShader,fragmentShader:h.line.fragmentShader}),this.dashed=!1,Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),this.setValues(t)}((g.prototype=Object.create(ht.ShaderMaterial.prototype)).constructor=g).prototype.isLineMaterial=!0,g.prototype.copy=function(t){return ht.ShaderMaterial.prototype.copy.call(this,t),this.color.copy(t.color),this.linewidth=t.linewidth,this.resolution=t.resolution,this};function l(t,e){ht.Mesh.call(this),this.type="LineSegments2",this.geometry=void 0!==t?t:new a,this.material=void 0!==e?e:new g({color:16777215*Math.random()})}var f,d;l.prototype=Object.assign(Object.create(ht.Mesh.prototype),{constructor:l,isLineSegments2:!0,computeLineDistances:(f=new ht.Vector3,d=new ht.Vector3,function(){for(var t=this.geometry,e=t.attributes.instanceStart,n=t.attributes.instanceEnd,r=new Float32Array(2*e.data.count),i=0,o=0,a=e.data.count;i<a;i++,o+=2)f.fromBufferAttribute(e,i),d.fromBufferAttribute(n,i),r[o]=0===o?0:r[o-1],r[o+1]=r[o]+f.distanceTo(d);var s=new ht.InstancedInterleavedBuffer(r,2,1);return lt(t,"instanceDistanceStart",new ht.InterleavedBufferAttribute(s,1,0)),lt(t,"instanceDistanceEnd",new ht.InterleavedBufferAttribute(s,1,1)),this}),copy:function(){return this}});function C(){a.call(this),this.type="LineGeometry"}C.prototype=Object.assign(Object.create(a.prototype),{constructor:C,isLineGeometry:!0,fromLine:function(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this},copy:function(){return this}});function x(t,e){l.call(this),this.type="Line2",this.geometry=void 0!==t?t:new C,this.material=void 0!==e?e:new g({color:16777215*Math.random()})}x.prototype=Object.assign(Object.create(l.prototype),{constructor:x,isLine2:!0,copy:function(){return this}});var v={interactive:!0,altitude:0,minZoom:0,maxZoom:30,asynchronous:!1},p=function(n){function t(t){var e=n.call(this)||this;return e.isBaseObject=!0,e.isAdd=!1,e.object3d=null,e.options={},e.toolTip=null,e.infoWindow=null,e._mouseover=!1,e._showPlayer=null,e._visible=!0,e._zoomVisible=!0,e._vt=null,e.picked=!1,e.pickObject3d=null,void 0===t&&(t=ut.Util.GUID()),e.id=t,e}i(t,n);var e=t.prototype;return e.addTo=function(t){return t instanceof tn?t.addMesh(this):console.error("layer only support maptalks.ThreeLayer"),this},e.remove=function(){var t=this.getLayer();return t&&t.removeMesh(this),this},e.getObject3d=function(){return this.object3d},e.getId=function(){return this.id},e.setId=function(t){var e=this.getId();return this.id=t,this._fire("idchange",{old:e,new:t,target:this}),this},e.getType=function(){return this.constructor.name},e.getOptions=function(){return this.options},e.getProperties=function(){return(this.options||{}).properties},e.setProperties=function(t){var e=Object.assign({},this.getProperties());return this.options.properties=t,this._fire("propertieschange",{old:e,new:t,target:this}),this},e.getLayer=function(){return this.options.layer},e.getMap=function(){var t=this.getLayer();if(t)return t.getMap()},e.getCenter=function(){var t=this.getOptions(),e=t.coordinate,n=t.lineString,r=t.polygon;if(e)return e;var i=r||n;return i&&i.getCenter?i.getCenter():void 0},e.getAltitude=function(){return this.getOptions().altitude},e.setAltitude=function(t){if(ut.Util.isNumber(t)){var e=this.getLayer().distanceToVector3(t,t).x;if(this.getObject3d().position.z=e,this.options.altitude=t,this.pickObject3d&&(this.pickObject3d.position.z=e),this._baseObjects&&Array.isArray(this._baseObjects))for(var n=0,r=this._baseObjects.length;n<r;n++)this._baseObjects[n]&&(this._baseObjects[n].getObject3d().position.z=e)}return this},e.show=function(){return this._zoomVisible&&(this.getObject3d().visible=!0,this._fire("show")),this._visible=!0,this},e.hide=function(){return this.getObject3d().visible=!1,this._fire("hide"),this._visible=!1,this},e.isVisible=function(){return!!this.getObject3d().visible},e.getSymbol=function(){return this.getObject3d().material},e.setSymbol=function(t){var e;return t&&t instanceof ht.Material&&(t.needsUpdate=!0,t.vertexColors=this.getObject3d().material.vertexColors,e=this.getObject3d().material.clone(),this.getObject3d().material=t,this._fire("symbolchange",{old:e,new:t,target:this})),this},e.setInfoWindow=function(t){return this.infoWindow=new ut.ui.InfoWindow(t),this},e.getInfoWindow=function(){return this.infoWindow},e.openInfoWindow=function(t){return t&&this.infoWindow&&this.infoWindow.show(t),this},e.closeInfoWindow=function(){return this.infoWindow&&this.infoWindow.hide(),this},e.removeInfoWindow=function(){return this.infoWindow&&this.infoWindow.remove()&&delete this.infoWindow,this},e.setToolTip=function(t,e){return this.toolTip=new o(t,e),this},e.getToolTip=function(){return this.toolTip},e.openToolTip=function(t){return t&&this.toolTip&&this.toolTip.show(t),this},e.closeToolTip=function(){return this.toolTip&&this.toolTip.hide(),this},e.removeToolTip=function(){return this.toolTip&&this.toolTip.remove()&&delete this.toolTip,this},e.animateShow=function(t,n){var r=this;void 0===t&&(t={}),this._showPlayer&&this._showPlayer.cancel(),ut.Util.isFunction(t)&&(n=t={});var e=t.duration||1e3,i=t.easing||"out",o=this._showPlayer=ut.animation.Animation.animate({scale:1},{duration:e,easing:i},function(t){var e=t.styles.scale;0<e&&r.getObject3d().scale.set(1,1,e),n&&n(t,e)});return o.play(),o},e.getMinZoom=function(){return this.getOptions().minZoom},e.getMaxZoom=function(){return this.getOptions().maxZoom},e.isAsynchronous=function(){return this.getOptions().asynchronous},e.fire=function(t,e){return this._fire(t,e),this._vt&&this._vt.onSelectMesh&&this._vt.onSelectMesh(t,e),this},e.config=function(){return this},e.setPickObject3d=function(t){return this.pickObject3d=t,this.pickObject3d.__parent=this},e._initOptions=function(t){return this.options=ut.Util.extend({},v,t),this},e._createMesh=function(t,e){return this.object3d=new ht.Mesh(t,e),this.object3d.__parent=this},e._createGroup=function(){return this.object3d=new ht.Group,this.object3d.__parent=this},e._createLine=function(t,e){return this.object3d=new ht.Line(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this},e._createLine2=function(t,e){return this.object3d=new x(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this},e._createPoints=function(t,e){return this.object3d=new ht.Points(t,e),this.object3d.__parent=this},e._createLineSegments=function(t,e){return this.object3d=new ht.LineSegments(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this},t}(ut.Eventable(function(){}));function U(t){for(var e={},n=0;n<t.length;++n){var r=t[n];for(var i in r)void 0===e[i]&&(e[i]=[]),e[i].push(r[i])}var o={},a=0,s=[];for(var c in e)if("indices"===c)for(var u=e[c],h=0,l=u.length;h<l;h++){for(var f=u[h],d=0,v=f.length;d<v;d++)s.push(f[d]+a);a+=e.position[h].length/3}else{var p=function(t){for(var e=0,n=0;n<t.length;++n){var r=t[n];e+=r.length}for(var i=new Float32Array(e),o=0,a=0;a<t.length;++a)i.set(t[a],o),o+=t[a].length;return i}(e[c]);if(!p)return null;o[c]=p}o.indices=new Uint32Array(s);var g=o.position,x=o.normal,y=o.uv,m=o.indices,b=new ht.BufferGeometry,_=new Float32Array(g.length);return _.fill(1,0,g.length),lt(b,"color",new ht.BufferAttribute(_,3)),lt(b,"normal",new ht.BufferAttribute(x,3)),lt(b,"position",new ht.BufferAttribute(g,3)),y&&y.length&&lt(b,"uv",new ht.BufferAttribute(y,2)),b.setIndex(new ht.BufferAttribute(m,1)),b}var y={},m="-";function R(t,e){void 0===e&&(e=!0);var n=t.height,r=t.radialSegments,i=t.radius,o=t._radius,a=t._height;if(!e){var s=new ht.CylinderBufferGeometry(i,i,n,r,1);s.rotateX(Math.PI/2);for(var c=s.attributes.position.array,u=0,h=c.length;u<h;u+=3)c[u+2]+=n/2;return s}for(var l=0;l<=4;l++){var f,d=[a+l,o,r].join(m).toString();if(f=y[d])break;if(d=[a-l,o,r].join(m).toString(),f=y[d])break}if(f)return f;var v=[a,o,r].join(m).toString();(f=y[v]=new ht.CylinderBufferGeometry(i,i,n,r,1)).rotateX(Math.PI/2);for(var p=f.attributes.position.array,g=0,x=p.length;g<x;g+=3)p[g+2]+=n/2;return f}function F(t,e,n,r,i){void 0===r&&(r="y"),void 0===i&&(i=0);var o=0;"y"===r?o=1:"z"===r&&(o=2);for(var a=t.attributes.position.array,s=a.length,c=e instanceof ht.Color?e:new ht.Color(e),u=new ht.Color(n),h=[],l=0;l<s;l+=3){i<a[l+o]?h.push(u.r,u.r,u.b):h.push(c.r,c.r,c.b)}return lt(t,"color",new ht.Float32BufferAttribute(h,3,!0)),h}var _={radius:10,height:100,radialSegments:6,altitude:0,topColor:null,bottomColor:"#2d2f61"},Z=function(d){function t(t,e,n,r){var i;e=ut.Util.extend({},_,e,{layer:r,coordinate:t}),(i=d.call(this)||this)._initOptions(e);var o=e.height,a=e.radius,s=e.topColor,c=e.bottomColor,u=e.altitude;e.height=r.distanceToVector3(o,o).x,e.radius=r.distanceToVector3(a,a).x,e._radius=i.options.radius,e._height=i.options.height,i._h=e.height;var h=R(e);s&&!n.map&&(F(h,c,s,"z",e.height/2),n.vertexColors=ht.VertexColors),i._createMesh(h,n);var l=r.distanceToVector3(u,u).x,f=r.coordinateToVector3(t,l);return i.getObject3d().position.copy(f),i}return i(t,d),t}(p),w=j,M=j;function j(t,e,n){n=n||2;var r,i,o,a,s,c,u,h=e&&e.length,l=h?e[0]*n:t.length,f=O(t,0,l,n,!0),d=[];if(!f||f.next===f.prev)return d;if(h&&(f=function(t,e,n,r){var i,o,a,s,c,u=[];for(i=0,o=e.length;i<o;i++)a=e[i]*r,s=i<o-1?e[i+1]*r:t.length,(c=O(t,a,s,r,!1))===c.next&&(c.steiner=!0),u.push(function(t){var e=t,n=t;for(;(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next,e!==t;);return n}(c));for(u.sort(T),i=0;i<u.length;i++)!function(t,e){{var n;(e=function(t,e){var n,r=e,i=t.x,o=t.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var s=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=i&&a<s){if((a=s)===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==e);if(!n)return null;if(i===a)return n;var c,u=n,h=n.x,l=n.y,f=1/0;r=n;for(;i>=r.x&&r.x>=h&&i!==r.x&&B(o<l?i:a,o,h,l,o<l?a:i,o,r.x,r.y)&&(c=Math.abs(o-r.y)/(i-r.x),E(r,t)&&(c<f||c===f&&(r.x>n.x||r.x===n.x&&function(t,e){return z(t.prev,t,e.prev)<0&&z(e.next,t,t.next)<0}(n,r)))&&(n=r,f=c)),r=r.next,r!==u;);return n}(t,e))&&(n=G(e,t),S(e,e.next),S(n,n.next))}}(u[i],n),n=S(n,n.next);return n}(t,e,f,n)),t.length>80*n){r=o=t[0],i=a=t[1];for(var v=n;v<l;v+=n)(s=t[v])<r&&(r=s),(c=t[v+1])<i&&(i=c),o<s&&(o=s),a<c&&(a=c);u=0!==(u=Math.max(o-r,a-i))?1/u:0}return A(f,d,n,r,i,u),d}function O(t,e,n,r,i){var o,a;if(i===0<q(t,e,n,r))for(o=e;o<n;o+=r)a=D(o,t[o],t[o+1],a);else for(o=n-r;e<=o;o-=r)a=D(o,t[o],t[o+1],a);return a&&I(a,a.next)&&(W(a),a=a.next),a}function S(t,e){if(!t)return t;e=e||t;var n,r=t;do{if(n=!1,r.steiner||!I(r,r.next)&&0!==z(r.prev,r,r.next))r=r.next;else{if(W(r),(r=e=r.prev)===r.next)break;n=!0}}while(n||r!==e);return e}function A(t,e,n,r,i,o,a){if(t){!a&&o&&function(t,e,n,r){var i=t;for(;null===i.z&&(i.z=k(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next,i!==t;);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,n,r,i,o,a,s,c,u=1;do{for(n=t,o=t=null,a=0;n;){for(a++,r=n,e=s=0;e<u&&(s++,r=r.nextZ);e++);for(c=u;0<s||0<c&&r;)0!==s&&(0===c||!r||n.z<=r.z)?(n=(i=n).nextZ,s--):(r=(i=r).nextZ,c--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;n=r}o.nextZ=null,u*=2}while(1<a)}(i)}(t,r,i,o);for(var s,c,u=t;t.prev!==t.next;)if(s=t.prev,c=t.next,o?function(t,e,n,r){var i=t.prev,o=t,a=t.next;if(0<=z(i,o,a))return!1;var s=i.x<o.x?i.x<a.x?i.x:a.x:o.x<a.x?o.x:a.x,c=i.y<o.y?i.y<a.y?i.y:a.y:o.y<a.y?o.y:a.y,u=i.x>o.x?i.x>a.x?i.x:a.x:o.x>a.x?o.x:a.x,h=i.y>o.y?i.y>a.y?i.y:a.y:o.y>a.y?o.y:a.y,l=k(s,c,e,n,r),f=k(u,h,e,n,r),d=t.prevZ,v=t.nextZ;for(;d&&d.z>=l&&v&&v.z<=f;){if(d!==t.prev&&d!==t.next&&B(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=z(d.prev,d,d.next))return!1;if(d=d.prevZ,v!==t.prev&&v!==t.next&&B(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&0<=z(v.prev,v,v.next))return!1;v=v.nextZ}for(;d&&d.z>=l;){if(d!==t.prev&&d!==t.next&&B(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=z(d.prev,d,d.next))return!1;d=d.prevZ}for(;v&&v.z<=f;){if(v!==t.prev&&v!==t.next&&B(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&0<=z(v.prev,v,v.next))return!1;v=v.nextZ}return!0}(t,r,i,o):function(t){var e=t.prev,n=t,r=t.next;if(0<=z(e,n,r))return!1;var i=t.next.next;for(;i!==t.prev;){if(B(e.x,e.y,n.x,n.y,r.x,r.y,i.x,i.y)&&0<=z(i.prev,i,i.next))return!1;i=i.next}return!0}(t))e.push(s.i/n),e.push(t.i/n),e.push(c.i/n),W(t),t=c.next,u=c.next;else if((t=c)===u){a?1===a?A(t=function(t,e,n){var r=t;do{var i=r.prev,o=r.next.next;!I(i,o)&&P(i,r,r.next,o)&&E(i,o)&&E(o,i)&&(e.push(i.i/n),e.push(r.i/n),e.push(o.i/n),W(r),W(r.next),r=t=o),r=r.next}while(r!==t);return S(r)}(S(t),e,n),e,n,r,i,o,2):2===a&&function(t,e,n,r,i,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&function(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&P(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(E(t,e)&&E(e,t)&&function(t,e){var n=t,r=!1,i=(t.x+e.x)/2,o=(t.y+e.y)/2;for(;n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next,n!==t;);return r}(t,e)&&(z(t.prev,t,e.prev)||z(t,e.prev,e))||I(t,e)&&0<z(t.prev,t,t.next)&&0<z(e.prev,e,e.next))}(a,s)){var c=G(a,s);return a=S(a,a.next),c=S(c,c.next),A(a,e,n,r,i,o),A(c,e,n,r,i,o)}s=s.next}a=a.next}while(a!==t)}(t,e,n,r,i,o):A(S(t),e,n,r,i,o,1);break}}}function T(t,e){return t.x-e.x}function k(t,e,n,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*i)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*i)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function B(t,e,n,r,i,o,a,s){return 0<=(i-a)*(e-s)-(t-a)*(o-s)&&0<=(t-a)*(r-s)-(n-a)*(e-s)&&0<=(n-a)*(o-s)-(i-a)*(r-s)}function z(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function I(t,e){return t.x===e.x&&t.y===e.y}function P(t,e,n,r){var i=V(z(t,e,n)),o=V(z(t,e,r)),a=V(z(n,r,t)),s=V(z(n,r,e));return i!==o&&a!==s||(0===i&&L(t,n,e)||(0===o&&L(t,r,e)||(0===a&&L(n,t,r)||!(0!==s||!L(n,e,r)))))}function L(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function V(t){return 0<t?1:t<0?-1:0}function E(t,e){return z(t.prev,t,t.next)<0?0<=z(t,e,t.next)&&0<=z(t,t.prev,e):z(t,e,t.prev)<0||z(t,t.next,e)<0}function G(t,e){var n=new H(t.i,t.x,t.y),r=new H(e.i,e.x,e.y),i=t.next,o=e.prev;return(t.next=e).prev=t,(n.next=i).prev=n,(r.next=n).prev=r,(o.next=r).prev=o,r}function D(t,e,n,r){var i=new H(t,e,n);return r?(i.next=r.next,(i.prev=r).next.prev=i,r.next=i):(i.prev=i).next=i,i}function W(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function H(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function q(t,e,n,r){for(var i=0,o=e,a=n-r;o<n;o+=r)i+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return i}function K(t,e){var n=t.length-1,r=[t[0]];return function t(e,n,r,i,o){for(var a,s,c,u,h,l,f,d,v,p=i,g=n+1;g<r;g++){var x=(s=e[g],c=e[n],u=e[r],v=d=f=l=h=void 0,l=c[0],f=c[1],d=u[0]-l,v=u[1]-f,0===d&&0===v||(1<(h=((s[0]-l)*d+(s[1]-f)*v)/(d*d+v*v))?(l=u[0],f=u[1]):0<h&&(l+=d*h,f+=v*h)),(d=s[0]-l)*d+(v=s[1]-f)*v);p<x&&(a=g,p=x)}i<p&&(1<a-n&&t(e,n,a,i,o),o.push(e[a]),1<r-a&&t(e,a,r,i,o))}(t,0,n,e,r),r.push(t[n]),r}function N(t,e,n){if(t.length<=2)return t;var r=void 0!==e?e*e:1;return t=K(t=n?t:function(t,e){for(var n,r,i,o,a,s=t[0],c=[s],u=1,h=t.length;u<h;u++)n=t[u],i=s,a=o=void 0,o=(r=n)[0]-i[0],a=r[1]-i[1],e<o*o+a*a&&(c.push(n),s=n);return s!==n&&c.push(n),c}(t,r),r)}function Q(t,e){var n=e[0],r=e[1],i=Math.sqrt(n*n+r*r);return t[0]=n/i,t[1]=r/i,t}function X(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t}function Y(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}j.deviation=function(t,e,n,r){var i=e&&e.length,o=i?e[0]*n:t.length,a=Math.abs(q(t,0,o,n));if(i)for(var s=0,c=e.length;s<c;s++){var u=e[s]*n,h=s<c-1?e[s+1]*n:t.length;a-=Math.abs(q(t,u,h,n))}for(var l=0,s=0;s<r.length;s+=3){var f=r[s]*n,d=r[s+1]*n,v=r[s+2]*n;l+=Math.abs((t[f]-t[v])*(t[1+d]-t[1+f])-(t[f]-t[d])*(t[1+v]-t[1+f]))}return 0===a&&0===l?0:Math.abs((l-a)/a)},j.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var o=0;o<t[i].length;o++)for(var a=0;a<e;a++)n.vertices.push(t[i][o][a]);0<i&&(r+=t[i-1].length,n.holes.push(r))}return n},w.default=M;var J=[];function ft(t,e,n,r){var i,o,a,s,c,u,h,l,f,d,v,p=(o=n,(i=e)[0]*o[0]+i[1]*o[1]+i[2]*o[2]),g=Math.acos(p)*r;return X(J,n,e,-p),c=(s=a=J)[0],u=s[1],h=s[2],l=Math.sqrt(c*c+u*u+h*h),a[0]=c/l,a[1]=u/l,a[2]=h/l,f=t,d=e,v=Math.cos(g),f[0]=d[0]*v,f[1]=d[1]*v,f[2]=d[2]*v,X(t,t,J,Math.sin(g)),t}function $(t,e,n){if(n-e<3)return 0;for(var r=0,i=2*(n-1),o=2*e;o<2*n;){var a=t[i],s=t[i+1],c=t[o],u=t[o+1],i=o;o+=2,r+=a*u-c*s}return r}var tt=[],et=[],nt=[];function rt(t,e,n,r,i,o,a,s){var c=null!=a,u=i,h=null;c&&(h=new Uint32Array(r-n));for(var l,f,d,v,p,g=n;g<r;g++){var x,y,m,b,_,w,M,j,O=g===r-1?n:g+1,S=g===n?r-1:g-1,A=t[2*S],C=t[2*S+1],T=t[2*g],k=t[2*g+1],B=t[2*O],z=t[2*O+1];tt[0]=T-A,tt[1]=k-C,et[0]=B-T,et[1]=z-k,Q(tt,tt),Q(et,et),c&&(h[g]=u),s||g!==n?s||g!==r-1?(v=et,p=tt,(d=nt)[0]=v[0]+p[0],d[1]=v[1]+p[1],x=nt[1],nt[1]=-nt[0],nt[0]=x,Q(nt,nt),f=et,y=(l=nt)[0]*f[0]+l[1]*f[1],m=Math.sqrt(1-y*y),b=o*Math.min(10,1/m),c&&a<1/m&&o*y<0?(_=T+nt[0]*o,w=k+nt[1]*o,M=Math.acos(m)/2,j=Math.tan(M)*Math.abs(o),e[2*u]=_+nt[1]*j,e[2*u+1]=w-nt[0]*j,e[2*++u]=_-nt[1]*j,e[2*u+1]=w+nt[0]*j):(e[2*u]=T+nt[0]*b,e[2*u+1]=k+nt[1]*b)):(nt[0]=tt[1],nt[1]=-tt[0],Q(nt,nt),e[2*u]=T+nt[0]*o,e[2*u+1]=k+nt[1]*o):(nt[0]=et[1],nt[1]=-et[0],Q(nt,nt),e[2*u]=T+nt[0]*o,e[2*u+1]=k+nt[1]*o),u++}return h}function it(t,e,n,r,i){var o=null!=r?[]:new Float32Array(t.length);if(rt(t,o,0,e&&e.length?e[0]:t.length/2,0,n,r,i),e)for(var a=0;a<e.length;a++){var s=e[a];rt(t,o,s,e[a+1]||t.length/2,null!=r?o.length/2:s,n,r,i)}return o}function ot(t,e,n,r){for(var i=0;i<Math.floor((r-n)/2);i++)for(var o=0;o<e;o++){var a=(i+n)*e+o,s=(r-i-1)*e+o,c=t[a];t[a]=t[s],t[s]=c}return t}function at(t){t.depth=t.depth||1,t.bevelSize=t.bevelSize||0,t.bevelSegments=null==t.bevelSegments?2:t.bevelSegments,t.smoothSide=t.smoothSide||!1,t.smoothBevel=t.smoothBevel||!1,t.simplify=t.simplify||0,"number"==typeof t.depth&&(t.bevelSize=Math.min(0<t.bevelSegments?t.bevelSize:0,t.depth/2)),0<t.bevelSize||(t.bevelSegments=0),t.bevelSegments=Math.round(t.bevelSegments);var e,n,r,i,o=t.boundingRect;t.translate=t.translate||[0,0],t.scale=t.scale||[1,1],t.fitRect&&(e=null==t.fitRect.x?o.x||0:t.fitRect.x,n=null==t.fitRect.y?o.y||0:t.fitRect.y,r=t.fitRect.width,i=t.fitRect.height,null==r?null!=i?r=i/o.height*o.width:(r=o.width,i=o.height):null==i&&(i=r/o.width*o.height),t.scale=[r/o.width,i/o.height],t.translate=[(e-o.x)*t.scale[0],(n-o.y)*t.scale[1]])}function st(t,e){function n(t,e,n,r){t[0]=e,t[1]=n,t[2]=r}for(var r,i,o,a,s,c,u,h,l,f=[],d=[],v=[],p=[],g=[],x=[],y=t.length,m=new Float32Array(e.length),b=0;b<y;){var _=3*t[b++],w=3*t[b++],M=3*t[b++];n(f,e[_],e[1+_],e[2+_]),n(d,e[w],e[1+w],e[2+w]),n(v,e[M],e[1+M],e[2+M]),Y(p,f,d),Y(g,d,v),r=x,o=g,l=h=u=c=s=a=void 0,a=(i=p)[0],s=i[1],c=i[2],u=o[0],h=o[1],l=o[2],r[0]=s*l-c*h,r[1]=c*u-a*l,r[2]=a*h-s*u;for(var j=0;j<3;j++)m[_+j]=m[_+j]+x[j],m[w+j]=m[w+j]+x[j],m[M+j]=m[M+j]+x[j]}for(var O,S,A,C,T,k,B=0;B<m.length;)n(x,m[B],m[B+1],m[B+2]),k=T=C=A=void 0,A=(S=O=x)[0],C=S[1],T=S[2],k=Math.sqrt(A*A+C*C+T*T),O[0]=A/k,O[1]=C/k,O[2]=T/k,m[B++]=x[0],m[B++]=x[1],m[B++]=x[2];return m}var dt=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function ct(t,e,n,r,i,o){var a=e.vertices,s=e.topVertices,c=e.depth,u=e.rect,h=r-n,l=o.smoothSide?1:2,f=h*l,d=o.smoothBevel?1:2,v=Math.min(c/2,o.bevelSize),p=o.bevelSegments,g=i.vertex,x=Math.max(u.width,u.height);if(0<v)for(var y=[0,0,1],m=[],b=[0,0,-1],_=[],w=0,M=new Float32Array(h),j=0;j<2;j++)for(var O=0===j?c-v:v,S=0;S<=p*d;S++){for(var A=0,C=void 0,T=void 0,k=0;k<h;k++){for(var B=0;B<l;B++){var z=2*((k+B)%h+n);m[0]=a[z]-s[z],m[1]=a[1+z]-s[1+z],m[2]=0;var I=Math.sqrt(m[0]*m[0]+m[1]*m[1]);m[0]/=I,m[1]/=I;var P=(Math.floor(S/d)+S%d)/p;0===j?ft(_,y,m,P):ft(_,m,b,P);var L,V,E,U,R=0===j?P:1-P,F=v*Math.sin(R*Math.PI/2),Z=I*Math.cos(R*Math.PI/2),G=v*I/Math.sqrt(F*F+Z*Z),D=_[0]*G+s[z],W=_[1]*G+s[1+z],H=_[2]*G+O;t.position[3*i.vertex]=D,t.position[3*i.vertex+1]=W,t.position[3*i.vertex+2]=H,(0<k||0<B)&&(A+=Math.sqrt((C-D)*(C-D)+(T-W)*(T-W))),(0<S||0<j)&&(L=3*(i.vertex-f),V=t.position[L],E=t.position[1+L],U=t.position[2+L],M[k]+=Math.sqrt((V-D)*(V-D)+(E-W)*(E-W)+(U-H)*(U-H))),t.uv[2*i.vertex]=A/x,t.uv[2*i.vertex+1]=M[k]/x,C=D,T=W,i.vertex++}if(1<d&&S%d||1==d&&1<=S)for(var q=0;q<6;q++){var K=(dt[q][0]+k*l)%f,N=dt[q][1]+w;t.indices[i.index++]=(N-1)*f+K+g}}w++}else for(var Q=0;Q<2;Q++)for(var X=0===Q?c-v:v,Y=0,J=void 0,$=void 0,tt=0;tt<h;tt++)for(var et=0;et<l;et++){var nt=2*((tt+et)%h+n),rt=a[nt],it=a[1+nt];t.position[3*i.vertex]=rt,t.position[3*i.vertex+1]=it,t.position[3*i.vertex+2]=X,(0<tt||0<et)&&(Y+=Math.sqrt((J-rt)*(J-rt)+($-it)*($-it))),t.uv[2*i.vertex]=Y/x,t.uv[2*i.vertex+1]=X/x,J=rt,$=it,i.vertex++}for(var ot=0<v?p*d+1:1,at=0;at<h;at++)for(var st=0;st<6;st++){var ct=(dt[st][0]+at*l)%f,ut=dt[st][1]+ot;t.indices[i.index++]=(ut-1)*f+ct+g}}function vt(t,e){for(var n=0,r=0,i=0;i<t.length;i++){var o=t[i],a=o.indices,s=o.vertices,c=o.holes,u=o.depth,h=s.length/2,l=0<Math.min(u/2,e.bevelSize)?e.bevelSegments:0;n+=a.length*(e.excludeBottom?1:2),r+=h*(e.excludeBottom?1:2);for(var f=2+2*l,d=0,v=0,p=0;p<(c?c.length:0)+1;p++){n+=6*((v=0===p?c&&c.length?c[0]:h:(d=c[p-1],c[p]||h))-d)*(f-1);var g=(v-d)*(e.smoothSide?1:2);r+=g*f+(e.smoothBevel?0:l*g*2)}}for(var x={position:new Float32Array(3*r),indices:new(65535<r?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*r)},y={vertex:0,index:0},m=0;m<t.length;m++)!function(t,e,n,r){var i=t.indices,o=t.vertices,a=t.topVertices,s=t.rect,c=t.depth;if(!(o.length<=4)){for(var u=n.vertex,h=i.length,l=0;l<h;l++)e.indices[n.index++]=u+i[l];for(var f=Math.max(s.width,s.height),d=0;d<(r.excludeBottom?1:2);d++)for(var v=0;v<a.length;v+=2){var p=a[v],g=a[v+1];e.position[3*n.vertex]=p,e.position[3*n.vertex+1]=g,e.position[3*n.vertex+2]=(1-d)*c,e.uv[2*n.vertex]=(p-s.x)/f,e.uv[2*n.vertex+1]=(g-s.y)/f,n.vertex++}if(!r.excludeBottom)for(var x=o.length/2,y=0;y<h;y+=3)for(var m=0;m<3;m++)e.indices[n.index++]=u+x+i[y+2-m]}}(t[m],x,y,e);for(var b=0;b<t.length;b++){var _,w=t[b],M=w.holes,j=w.vertices.length/2,O=M&&M.length?M[0]:j;if(ct(x,t[b],0,O,y,e),M)for(var S=0;S<M.length;S++)_=M[S],O=M[S+1]||j,ct(x,t[b],_,O,y,e)}for(var A=0;A<x.uv.length;A++){var C=x.uv[A];0<C&&Math.round(C)===C?x.uv[A]=1:x.uv[A]=C%1}return x.normal=st(x.indices,x.position),x.boundingRect=t[0]&&t[0].rect,x}function pt(t,e){e=Object.assign({},e);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<t.length;i++)xt(t[i][0],n,r);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},at(e);for(var o,a=[],s=e.translate||[0,0],c=e.scale||[1,1],u=e.boundingRect,h={x:u.x*c[0]+s[0],y:u.y*c[1]+s[1],width:u.width*c[0],height:u.height*c[1]},l=Math.min(u.width,u.height)/1e5,f=0;f<t.length;f++){var d=function(t,e){for(var n=[],r=0;r<t.length;r++){for(var i=t[r],o=[],a=i.length,s=i[a-1][0],c=i[a-1][1],u=0,h=0;h<a;h++){var l=i[h][0],f=i[h][1],d=l-s,v=f-c;e<(u+=Math.sqrt(d*d+v*v))&&(o.push(i[h]),u=0),s=l,c=f}3<=o.length&&n.push(o)}return 0<n.length?n:null}(t[f],l);if(d){var v=e.simplify/Math.max(c[0],c[1]);if(0<v&&(d=function(t,e){for(var n=[],r=0;r<t.length;r++){var i=t[r];3<=(i=N(i,e,!0)).length&&n.push(i)}return 0<n.length?n:null}(d,v)),d){for(var p=w.flatten(d),g=p.vertices,x=p.holes,y=p.dimensions,m=0;m<g.length;)g[m]=g[m++]*c[0]+s[0],g[m]=g[m++]*c[1]+s[1];if(!function(t,e){var n=t.length/2,r=0,i=e&&e.length?e[0]:n;0<$(t,r,i)&&ot(t,2,r,i);for(var o=1;o<(e?e.length:0)+1;o++)$(t,r=e[o-1],i=e[o]||n)<0&&ot(t,2,r,i)}(g,x),2!==y)throw new Error("Only 2D polygon points are supported");var b=0<e.bevelSize?it(g,x,e.bevelSize,null,!0):g,_=(void 0===(o=y)&&(o=2),w(b,x,o));a.push({indices:_,vertices:g,topVertices:b,holes:x,rect:h,depth:"function"==typeof e.depth?e.depth(f):e.depth})}}}return vt(a,e)}function gt(t,e){e=Object.assign({},e);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<t.length;i++)xt(t[i],n,r);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},at(e);var o=e.scale||[1,1];null==e.lineWidth&&(e.lineWidth=1),null==e.miterLimit&&(e.miterLimit=2);for(var a=[],s=0;s<t.length;s++){var c=t[s],u=e.simplify/Math.max(o[0],o[1]);0<u&&(c=N(c,u,!0)),a.push(function(t,e,n){for(var r=n.lineWidth,i=t.length,o=new Float32Array(2*i),a=n.translate||[0,0],s=n.scale||[1,1],c=0,u=0;c<i;c++)o[u++]=t[c][0]*s[0]+a[0],o[u++]=t[c][1]*s[1]+a[1];$(o,0,i)<0&&ot(o,2,0,i);var h=[],l=[],f=n.miterLimit,d=rt(o,l,0,i,0,-r/2,f,!1);ot(o,2,0,i);for(var v=rt(o,h,0,i,0,-r/2,f,!1),p=(h.length+l.length)/2,g=new Float32Array(2*p),x=0,y=l.length/2,m=0;m<l.length;m++)g[x++]=l[m];for(var b=0;b<h.length;b++)g[x++]=h[b];for(var _=new(65535<p?Uint32Array:Uint16Array)(3*(2*(i-1)+(p-2*i))),w=0,M=0;M<i-1;M++){var j=M+1;_[w++]=y-1-d[M],_[w++]=y-1-d[M]-1,_[w++]=v[M]+1+y,_[w++]=y-1-d[M],_[w++]=v[M]+1+y,_[w++]=v[M]+y,v[j]-v[M]==2?(_[w++]=v[M]+2+y,_[w++]=v[M]+1+y,_[w++]=y-d[j]-1):d[j]-d[M]==2&&(_[w++]=v[j]+y,_[w++]=y-1-(d[M]+1),_[w++]=y-1-(d[M]+2))}var O=0<n.bevelSize?it(g,[],n.bevelSize,null,!0):g,S=n.boundingRect;return{vertices:g,indices:_,topVertices:O,rect:{x:S.x*s[0]+a[0],y:S.y*s[1]+a[1],width:S.width*s[0],height:S.height*s[1]},depth:"function"==typeof n.depth?n.depth(e):n.depth,holes:[]}}(c,s,e))}return vt(a,e)}function xt(t,e,n){for(var r=0;r<t.length;r++)e[0]=Math.min(t[r][0],e[0]),e[1]=Math.min(t[r][1],e[1]),n[0]=Math.max(t[r][0],n[0]),n[1]=Math.max(t[r][1],n[1])}var yt=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"];function mt(t){return void 0===t&&(t={}),(t.geometry||{}).type}function bt(t){void 0===t&&(t={});var e=mt(t);if(e)for(var n=0,r=yt.length;n<r;n++)if(yt[n]===e)return 1}function _t(t){void 0===t&&(t={});var e=mt(t);return!(!e||e!==yt[4]&&e!==yt[5])}function wt(t){void 0===t&&(t={});var e=mt(t);return!(!e||e!==yt[2]&&e!==yt[3])}function Mt(t){return void 0===t&&(t={}),(t.geometry||{}).coordinates||[]}function jt(t){void 0===t&&(t={});var e=mt(t);if(!e)return null;var n=(t.geometry||{}).coordinates;if(!n)return null;var r=[];switch(e){case"Point":r.push(n);break;case"MultiPoint":case"LineString":for(var i=0,o=n.length;i<o;i++)r.push(n[i]);break;case"MultiLineString":case"Polygon":for(var a=0,s=n.length;a<s;a++)for(var c=0,u=n[a].length;c<u;c++)r.push(n[a][c]);break;case"MultiPolygon":for(var h=0,l=n.length;h<l;h++)for(var f=0,d=n[h].length;f<d;f++)for(var v=0,p=n[h][f].length;v<p;v++)r.push(n[h][f][v])}for(var g=1/0,x=1/0,y=-1/0,m=-1/0,b=0,_=r.length;b<_;b++)var w=r[b],M=w[0],j=w[1],g=Math.min(g,M),x=Math.min(x,j),y=Math.max(y,M),m=Math.max(m,j);return new ut.Coordinate((g+y)/2,(x+m)/2)}function Ot(t){void 0===t&&(t={});var e=mt(t);if(!e)return null;var n=t.geometry||{},r=t.properties||{},i=n.coordinates;if(!i)return null;var o,a=[];switch(e){case"MultiPoint":o="Point";break;case"MultiLineString":o="LineString";break;case"MultiPolygon":o="Polygon"}if(o)for(var s=0,c=i.length;s<c;s++)a.push({type:"Feature",geometry:{type:o,coordinates:i[s]},properties:r});else a.push(t);return a}var St=",";function At(t,e,n){var r=[],i=[];if(Array.isArray(t)&&t[0]instanceof ht.Vector3)for(var o=0,a=t.length;o<a;o++){var s=t[o];r.push(s.x,s.y,s.z),i.push(s)}else{Array.isArray(t)&&(t=new ut.LineString(t));for(var c,u=bt(t)?(c=Mt(t),jt(t)):(c=t.getCoordinates(),t.getCenter()),h=e.coordinateToVector3(n||u),l=0,f=c.length;l<f;l++){var d=c[l];Array.isArray(d)&&(d=new ut.Coordinate(d));var v=e.coordinateToVector3(d,0).sub(h);r.push(v.x,v.y,v.z),i.push(v)}}return{positions:r,positionsV:i}}function Ct(t,e,n,r){for(var i=[],o=[],a=[],s=0,c=t.length;s<c;s++)for(var u=t[s],h=0,l=u.length;h<l;h++){var f=u[h];0<a.length&&f.join(St).toString()===a[a.length-1].join(St).toString()||a.push(f)}for(var d=0,v=a.length;d<v;d++){var p=a[d],g=void 0,x=p.join(St).toString(),g=n&&n[x]?n[x]:e.coordinateToVector3(p,0).sub(r);o.push(g),i.push(g.x,g.y,g.z)}return{positions:i,positionsV:o,lnglats:a}}function Tt(t,e,n,r,i){void 0===e&&(e=1),void 0===n&&(n=1);for(var o=At(t,r,i).positionsV,a=[],s=0,c=o.length;s<c;s++){var u=o[s];a.push([u.x,u.y])}var h=gt([a],{lineWidth:e,depth:n}),l=h.indices;return{position:h.position,normal:h.normal,indices:l,uv:h.uv}}var kt={altitude:0,colors:null},Bt=function(v){function t(t,e,n,r){var i;e=ut.Util.extend({},kt,e,{layer:r,lineString:t}),(i=v.call(this)||this)._initOptions(e);var o=At(t,r).positions,a=new ht.BufferGeometry;lt(a,"position",new ht.Float32BufferAttribute(o,3));var s,c,u=(s=e.colors,c=[],s&&s.length&&s.forEach(function(t){t=t instanceof ht.Color?t:new ht.Color(t),c.push(t.r,t.g,t.b)}),c);u&&u.length&&(lt(a,"color",new ht.Float32BufferAttribute(u,3)),n.vertexColors=ht.VertexColors),i._createLine(a,n);var h=e.altitude,l=bt(t)?jt(t):t.getCenter(),f=r.distanceToVector3(h,h).x,d=r.coordinateToVector3(l,f);return i.getObject3d().position.copy(d),i}return i(t,v),t}(p),zt={width:3,height:1,altitude:0},It=function(f){function t(t,e,n,r){var i;e=ut.Util.extend({},zt,e,{layer:r,lineString:t}),(i=f.call(this)||this)._initOptions(e);var o=e.height,a=e.width;e.height=r.distanceToVector3(o,o).x,e.width=r.distanceToVector3(a,a).x;var s=function(t,e,n,r,i){void 0===e&&(e=1),void 0===n&&(n=1);for(var o=At(t,r,i).positionsV,a=[],s=0,c=o.length;s<c;s++){var u=o[s];a.push([u.x,u.y])}var h=gt([a],{lineWidth:e,depth:n}),l=h.indices,f=h.position,d=h.normal,v=h.uv,p=new ht.BufferGeometry;return lt(p,"position",new ht.Float32BufferAttribute(f,3)),lt(p,"normal",new ht.Float32BufferAttribute(d,3)),lt(p,"uv",new ht.Float32BufferAttribute(v,2)),p.setIndex(new ht.Uint32BufferAttribute(l,1)),p}(t,e.width,e.height,r);i._createMesh(s,n);var c=e.altitude,u=bt(t)?jt(t):t.getCenter(),h=r.distanceToVector3(c,c).x,l=r.coordinateToVector3(u,h);return i.getObject3d().position.copy(l),i}return i(t,f),t}(p);function Pt(t,e,n,r){var i=Et(t,n,r);if(!i)return null;var o=pt(i,{depth:e=n.distanceToVector3(e,e).x});return{position:o.position,normal:o.normal,uv:o.uv,indices:o.indices}}function Lt(t,e,n){for(var r=t.attributes.position.array,i=r.length,o=e instanceof ht.Color?e:new ht.Color(e),a=new ht.Color(n),s=[],c=0;c<i;c+=3){0<r[c+2]?s.push(a.r,a.r,a.b):s.push(o.r,o.r,o.b)}return lt(t,"color",new ht.Float32BufferAttribute(s,3,!0)),s}function Vt(t){void 0===t&&(t=[]);for(var e=1/0,n=1/0,r=-1/0,i=-1/0,o=0,a=t.length;o<a;o++){var s=t[o],c=void 0,u=void 0;Array.isArray(s)?(c=s[0],u=s[1]):s instanceof ut.Coordinate&&(c=s.x,u=s.y),e=Math.min(e,c),n=Math.min(n,u),r=Math.max(r,c),i=Math.max(i,u)}return new ut.Coordinate((e+r)/2,(n+i)/2)}function Et(e,n,r,i){if(void 0===i&&(i=!1),!e)return null;var t=[];if(e instanceof ut.MultiPolygon)t=e.getGeometries().map(function(t){return Ut(t,n,r||e.getCenter(),i)});else if(e instanceof ut.Polygon){var o=Ut(e,n,r||e.getCenter(),i);t.push(o)}else if(_t(e)){var a=jt(e);if(function(t){void 0===t&&(t={});var e=mt(t);return!!(e&&-1<e.indexOf("Multi"))}(e))for(var s=Ot(e),c=0,u=s.length;c<u;c++)t.push(Ut(s[c],n,r||a,i));else{var h=Ut(e,n,r||a,i);t.push(h)}}return t}function Ut(t,e,n,r){var i,o,a;void 0===r&&(r=!1),n=_t(t)?(o=(i=Mt(t))[0],a=i.slice(1,i.length),n||jt(t)):(o=t.getShell(),a=t.getHoles(),n||t.getCenter());for(var s=e.coordinateToVector3(n),c=r?new Float32Array(2*o.length):[],u=0,h=o.length;u<h;u++){var l,f=o[u],d=e.coordinateToVector3(f).sub(s);r?(c[l=2*u]=d.x,c[1+l]=d.y):c.push([d.x,d.y])}var v=[r?c.buffer:c];if(a&&0<a.length)for(var p=0,g=a.length;p<g;p++){for(var x=r?new Float32Array(2*a[p].length):[],y=0,m=a[p].length;y<m;y++){var b,_=a[p][y],w=e.coordinateToVector3(_).sub(s);r?(x[b=2*y]=w.x,x[1+b]=w.y):x.push([w.x,w.y])}v.push(r?x.buffer:x)}return v}var Rt={altitude:0,height:1,topColor:null,bottomColor:"#2d2f61"},Ft=function(d){function t(t,e,n,r){var i;e=ut.Util.extend({},Rt,e,{layer:r,polygon:t}),(i=d.call(this)||this)._initOptions(e);var o=e.height,a=e.topColor,s=e.bottomColor,c=e.altitude,u=function(t,e,n,r){var i=Pt(t,e,n,r),o=i.position,a=i.normal,s=i.uv,c=i.indices,u=new Float32Array(o.length);u.fill(1,0,o.length);var h=new ht.BufferGeometry;return lt(h,"color",new ht.BufferAttribute(u,3)),lt(h,"normal",new ht.BufferAttribute(a,3)),lt(h,"position",new ht.BufferAttribute(o,3)),lt(h,"uv",new ht.BufferAttribute(s,2)),h.setIndex(new ht.Uint32BufferAttribute(c,1)),h}(t,o,r),h=_t(t)?jt(t):t.getCenter();a&&!n.map&&(Lt(u,s,a),n.vertexColors=ht.VertexColors),i._createMesh(u,n);var l=r.distanceToVector3(c,c).x,f=r.coordinateToVector3(h,l);return i.getObject3d().position.copy(f),i}return i(t,d),t}(p),Zt={altitude:0,coordinate:null},Gt=function(c){function t(t,e,n){var r;void 0===e&&(e={}),e.coordinate||(console.warn("coordinate is null,it is important to locate the model"),e.coordinate=n.getMap().getCenter()),e=ut.Util.extend({},Zt,e,{layer:n,model:t}),(r=c.call(this)||this)._initOptions(e),r._createGroup(),r.getObject3d().add(t);var i=e.altitude,o=e.coordinate,a=n.distanceToVector3(i,i).x,s=n.coordinateToVector3(o,a);return r.getObject3d().position.copy(s),r}return i(t,c),t}(p),Dt=Math.PI/180,Wt=6378137,Ht=1;function qt(t){return t*Dt}function Kt(t,e){void 0===e&&(e=10),e=Math.max(e,Ht),Array.isArray(t)||(t=t.getCoordinates().map(function(t){return t.toArray()}));for(var n=t.length,r=[],i=0,o=0;o<n-1;o++){var a=function(t,e){if(!t||!e)return 0;Array.isArray(t)||(t=t.toArray()),Array.isArray(e)||(e=e.toArray());var n=qt(t[1]),r=qt(e[1]),i=n-r,o=qt(t[0])-qt(e[0]),n=2*Math.asin(Math.sqrt(Math.pow(Math.sin(i/2),2)+Math.cos(n)*Math.cos(r)*Math.pow(Math.sin(o/2),2)));return n*=Wt,Math.round(1e5*n)/1e5}(t[o],t[o+1]),s=Math.floor(a);r.push({c1:t[o],len:s,c2:t[o+1]}),i+=s}if(i<=e)return r.map(function(t){return[t.c1,t.c2]});if(1===r.length&&r[0].len<=e)return[[r[0].c1,r[0].c2]];for(var c,u,h,l,f,d,v,p,g,x=r.length,y=0,m=0,b=[],_=[r[0].c1];y<x;){var w,M=r[y],j=M.len,O=M.c2;(m+=j)<e&&(_.push(O),y===x-1&&b.push(_),y++),m===e&&(_.push(O),m=0,b.push(_),_=[O],y++),e<m&&(w=j-m+e,u=r[y],h=w,g=p=v=d=f=l=void 0,l=u.len,f=u.c1,d=u.c2,v=d[0]-f[0],p=d[1]-f[1],g=h/l,c=[f[0]+g*v,f[1]+g*p],_.push(c),b.push(_),m=0,r[y].c1=c,r[y].len=j-w,(_=[]).push(c))}return b}function Nt(t,e,n,r){var i=e.length;t.attributes.normal.count=i,t.attributes.position.count=i;for(var o=t.attributes.position.array,a=t.attributes.normal.array,s=0;s<i;s++)o[s]=e[s],a[s]=n[s];t.index.count=r.length;for(var c=0,u=r.length;c<u;c++)t.index.array[c]=r[c]}function Qt(t){return function(t){function e(){return t.apply(this,arguments)||this}i(e,t);var n=e.prototype;return n._initBaseObjectsEvent=function(t){if(t&&Array.isArray(t)&&t.length)for(var e=0,n=t.length;e<n;e++){var r=t[e];this._proxyEvent(r)}return this},n._proxyEvent=function(t){var e=this;t.on("add",function(t){e._showGeometry(t.target,!0)}),t.on("remove",function(t){e._showGeometry(t.target,!1)}),t.on("mouseout",function(t){e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}))}),t.on(te,function(t){e.fire(t.type,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}))})},n._getHideGeometryIndex=function(t){for(var e=[],n=0,r=0,i=this._geometriesAttributes.length;r<i;r++)!0===this._geometriesAttributes[r].hide&&(e.push(r),n+=this._geometriesAttributes[r][t].count);return{indexs:e,count:n}},n._updateAttribute=function(t,e){for(var n=this._getHideGeometryIndex(e).indexs,r=this._geometryCache.attributes[e].array,i=r.length,o=0;o<i;o++)t.array[o]=r[o];var a=NaN;this.getObject3d()instanceof ht.LineSegments&&(a=0);for(var s=0;s<n.length;s++)for(var c=n[s],u=this._geometriesAttributes[c][e],h=u.start,l=u.end,f=h;f<l;f++)t.array[f]=a;return this},n._showGeometry=function(t,e){var n;if(t&&(n=t.getOptions().index),null!=n){var r=this._geometriesAttributes[n];if(r.hide===e)return this;r.hide=e;var i=this.getObject3d().geometry;this._updateAttribute(i.attributes.position,"position"),i.attributes.position.needsUpdate=!0,this.isHide=e}return this},n.getSelectMesh=function(){return{data:null,baseObject:null}},e}(t)}var Xt,Yt,Jt={trail:5,chunkLength:50,width:2,height:1,speed:1,altitude:0,interactive:!1},$t=function(I){function t(t,e,n,r){var i;e=ut.Util.extend({},Jt,e,{layer:r,lineString:t}),(i=I.call(this)||this)._initOptions(e);for(var o,a=e.width,s=e.height,c=e.altitude,u=e.speed,h=e.chunkLength,l=e.trail,f=bt(t)?(o=jt(t),Mt(t)):(o=t.getCenter(),t),d=Kt(f,h),v=r.coordinateToVector3(t.getCenter()),p={},g=0,x=d.length;g<x;g++)for(var y=d[g],m=0,b=y.length;m<b;m++){var _=y[m],w=_.join(",").toString();p[w]||(p[w]=r.coordinateToVector3(_).sub(v))}var M=Ct(d.slice(0,1),r,p,v).positionsV,j=new ht.BufferGeometry,O=new Float32Array(3e3),S=new Float32Array(3e3),A=new Uint16Array(1e3);lt(j,"position",new ht.BufferAttribute(O,3)),lt(j,"normal",new ht.BufferAttribute(S,3)),j.setIndex(new ht.BufferAttribute(A,1));var C=r.distanceToVector3(a,a).x,T=r.distanceToVector3(s,s).x,k=Tt(M,C,T,r);Nt(j,k.position,k.normal,k.indices),i._createMesh(j,n);var B=r.distanceToVector3(c,c).x,z=r.coordinateToVector3(o,B);return i.getObject3d().position.copy(z),i._params={index:0,chunkLines:d,geometries:[],layer:r,trail:Math.max(1,l),lineWidth:C,depth:T,speed:Math.min(1,u),idx:0,loaded:!1,positionMap:p,centerPt:v},i._init(i._params),i}i(t,I);var e=t.prototype;return e._init=function(t){for(var e=t.layer,n=t.trail,r=t.lineWidth,i=t.depth,o=t.chunkLines,a=t.positionMap,s=t.centerPt,c=o.length,u=[],h=0;h<c;h++){var l=Ct(o.slice(h,h+n),e,a,s).positionsV;u.push(Tt(l,r,i,e))}this._params.geometries=u,this._params.loaded=!0},e._animation=function(){var t,e,n=this._params,r=n.index,i=n.geometries,o=n.speed,a=n.idx,s=n.chunkLines,c=n.trail,u=n.lineWidth,h=n.depth,l=n.loaded,f=n.layer,d=n.positionMap,v=n.centerPt;l&&(a<(t=Math.round(r))&&(this._params.idx++,(e=i[t])||(e=Tt(Ct(s.slice(t,t+c),f,d,v).positionsV,u,h,f),i[t]=e),Nt(this.getObject3d().geometry,e.position,e.normal,e.indices),this.getObject3d().geometry.attributes.position.needsUpdate=!0,this.getObject3d().geometry.attributes.normal.needsUpdate=!0,this.getObject3d().geometry.index.needsUpdate=!0),r>=s.length-1&&(this._params.index=-1,this._params.idx=-1),this._params.index+=o)},t}(p),te=["click","mousemove","mousedown","mouseup","dblclick","contextmenu"].join(" ").toString(),ee={name:"maptalks.three",version:"0.11.3",description:"A maptalks Layer to render with THREE.js.",license:"MIT",repository:{type:"git",url:"https://github.com/maptalks/maptalks.three.js.git"},files:["dist/maptalks.three.js","dist/maptalks.three.min.js","dist/maptalks.three.es.js","dist/maptalks.three.js.map"],main:"dist/maptalks.three.js",module:"dist/maptalks.three.es.js","jsnext:main":"dist/maptalks.three.es.js",scripts:{dev:"rollup -w -c rollup.config.js",build:"rollup --environment BUILD:production -c rollup.config.js","build-dev":"rollup -c rollup.config.js",preversion:"npm run lint",version:"npm run build && git add -A dist",lint:"eslint index.js src/**/*.js test/**/*.js",prepublish:"npm run lint && npm run build"},devDependencies:{"@babel/core":"^7.0.0","@babel/preset-env":"^7.0.0","babel-eslint":"^9.0.0",eslint:"^4.19.1","eslint-config-maptalks":"^0.3.0","eslint-plugin-mocha":"^5.0.0",rollup:"^0.66.1","rollup-plugin-babel":"^4.1.0-0","rollup-plugin-commonjs":"^9.1.0","rollup-plugin-json":"^4.0.0","rollup-plugin-node-resolve":"^3.3.0","rollup-plugin-uglify":"^6.0.0",three:"^0.97.0"},peerDependencies:{maptalks:">=0.39.0"},dependencies:{"geometry-extrude":"^0.1.2"}};ut.worker&&(Xt=function(t){function e(){return t.apply(this,arguments)||this}i(e,t);var n=e.prototype;return n.test=function(t,e){this.send(t,null,e)},n.pushQueue=function(t){void 0===t&&(t={});var e,n=t.type,r=t.data,i=t.callback,o=t.layer,a=t.key,s=t.center;"Polygon"===n&&(e=function(t,e,n){void 0===t&&(t=[]);for(var r=t.length,i=[],o=[],a=0;a<r;a++){for(var s=t[a],c=Et(s,n,e,!0),u=0,h=c.length;u<h;u++)for(var l=c[u],f=0,d=l.length;f<d;f++)o.push(l[f]);var v=(_t(s)?s.properties:s.getProperties()||{}).height||1;v=n.distanceToVector3(v,v).x,i.push({data:c,height:v})}return{datas:i,transfer:o}}(r,s,o)),this.send({type:n,datas:e.datas},e.transfe,function(t,e){t&&console.error(t),e.key=a,i(e)})},e}(ut.worker.Actor));var ne={altitude:0,height:1,topColor:null,bottomColor:"#2d2f61"},re=function(V){function t(t,e,i,n){var o;Array.isArray(t)||(t=[t]);for(var r=[],a=t.length,s=0;s<a;s++){var c=t[s];r.push(_t(c)?jt(c):c.getCenter())}var u=Vt(r),h=(e=ut.Util.extend({},ne,e,{layer:n,polygons:t,coordinate:u})).topColor,l=e.bottomColor,f=e.altitude,d=[],v=[],p=[];if(e.asynchronous){var g=(ut.worker||console.error("maptalks.worker is not defined,You can't use ThreeVectorTileLayer"),Yt=Yt||new Xt(ee.name)),x=new ht.BoxBufferGeometry(1e-6,1e-6,1e-6*5);g.pushQueue({type:"Polygon",layer:n,key:e.key,center:u,data:t,callback:function(t){var e=t.faceMap,n=t.geometriesAttributes;o._faceMap=e,o._geometriesAttributes=n;var r=function(t){var e=t.position,n=t.normal,r=t.uv,i=t.indices,o=new Float32Array(e.length);o.fill(1,0,e.length);var a=new ht.BufferGeometry;return lt(a,"color",new ht.BufferAttribute(o,3)),lt(a,"normal",new ht.BufferAttribute(new Float32Array(n),3)),lt(a,"position",new ht.BufferAttribute(new Float32Array(e),3)),lt(a,"uv",new ht.BufferAttribute(new Float32Array(r),2)),a.setIndex(new ht.BufferAttribute(new Uint32Array(i),1)),a}(t);h&&!i.map&&(Lt(r,l,h),i.vertexColors=ht.VertexColors),o.getObject3d().geometry.dispose(),o.getObject3d().geometry=r,o.getObject3d().material.needsUpdate=!0,o._geometryCache=r.clone(),o._fire("workerload",{target:function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(o)})}})}else{for(var y=[],m=0,b=0,_=0,w=0,M=0;M<a;M++){var j=t[M],O=(_t(j)?j.properties:j.getProperties()||{}).height||1,S=Pt(j,O,n,u);y.push(S);var A=S.position,C=S.normal,T=S.uv,k=S.indices.length/3;v[M]=[m+1,m+k],m+=k;var B=A.length/3,z=C.length/3,I=T.length/2;p[M]={position:{count:B,start:b,end:b+3*B},normal:{count:z,start:_,end:_+3*z},uv:{count:I,start:w,end:w+2*I},hide:!1},b+=3*B,_+=3*z,w+=2*I}x=U(y),h&&!i.map&&(Lt(x,l,h),i.vertexColors=ht.VertexColors)}(o=V.call(this)||this)._initOptions(e),o._createMesh(x,i);var P=n.distanceToVector3(f,f).x,L=n.coordinateToVector3(u,P);return o.getObject3d().position.copy(L),o._faceMap=v,o._baseObjects=d,o._datas=t,o._geometriesAttributes=p,o.faceIndex=null,o._geometryCache=x.clone(),o.isHide=!1,o._initBaseObjectsEvent(d),o}i(t,V);var e=t.prototype;return e.getSelectMesh=function(){var t,e,n=this._getIndex();if(null!=n)return this._baseObjects[n]||(t=this._datas[n],e=Object.assign({},this.options,_t(t)?t.properties:t.getProperties(),{index:n}),this._baseObjects[n]=new Ft(t,e,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[n])),{data:this._datas[n],baseObject:this._baseObjects[n]}},e._getIndex=function(t){if(null==t&&(t=this.faceIndex),null!=t)for(var e=0,n=this._faceMap.length;e<n;e++){var r=this._faceMap[e],i=r[0],o=r[1];if(i<=t&&t<o)return e}},t}(Qt(p));function ie(t,e,n){var r=t.project(n),i=e.width/2,o=e.height/2;return{x:Math.round(r.x*i+i),y:Math.round(-r.y*o+o)}}var oe={altitude:0,height:0},ae=new ht.Vector3,se=function(p){function t(t,e,n,r){var i;e=ut.Util.extend({},oe,e,{layer:r,coordinate:t}),i=p.call(this)||this;var o=e.height,a=e.altitude,s=e.color,c=[],u=[];s&&(s=s instanceof ht.Color?s:new ht.Color(s),u.push(s.r,s.g,s.b));var h=r.distanceToVector3(o,o).x,l=r.coordinateToVector3(t,h);c.push(0,0,l.z);var f=new ht.BufferGeometry;lt(f,"position",new ht.Float32BufferAttribute(c,3,!0)),u.length&&lt(f,"color",new ht.Float32BufferAttribute(u,3,!0)),e.positions=l,i._initOptions(e),i._createPoints(f,n);var d=r.distanceToVector3(a,a).x,v=new ht.Vector3(l.x,l.y,d);return i.getObject3d().position.copy(v),i}return i(t,p),t.prototype.identify=function(t){var e=this.getLayer(),n=this.getMap().getSize(),r=this.getLayer().getCamera(),i=this.getOptions().positions,o=this.getOptions().altitude,a=this.getObject3d().material.size,s=this.getMap().coordToContainerPoint(t),c=e.distanceToVector3(o,o).x;ae.x=i.x,ae.y=i.y,ae.z=i.z+c;var u=ie(ae,n,r);return Math.sqrt(Math.pow(s.x-u.x,2)+Math.pow(s.y-u.y,2))<=a/2},t}(p);function ce(t,e){var n=t.minx,r=t.miny,i=t.maxx,o=t.maxy,a=e[0],s=e[1];return n<=a&&a<=i&&r<=s&&s<=o}var ue=function(){function f(t,e,n,r){this.minlng=t,this.minlat=e,this.maxlng=n,this.maxlat=r,this.minx=1/0,this.miny=1/0,this.maxx=-1/0,this.maxy=-1/0,this.coordinates=[],this.positions=[],this.indexs=[],this.key=null}var t=f.prototype;return t.updateBBoxPixel=function(e){var n=1/0,r=1/0,i=-1/0,o=-1/0,t=this.minlng,a=this.minlat,s=this.maxlng,c=this.maxlat;return[[t,a],[t,c],[s,a],[s,c]].map(function(t){return new ut.Coordinate(t)}).map(function(t){return e.coordToContainerPoint(t)}).forEach(function(t){n=Math.min(n,t.x),r=Math.min(r,t.y),i=Math.max(i,t.x),o=Math.max(o,t.y)}),this.minx=n,this.miny=r,this.maxx=i,this.maxy=o,this},t.containsCoordinate=function(t){var e,n;Array.isArray(t)?(e=t[0],n=t[1]):t instanceof ut.Coordinate&&(e=t.x,n=t.y);var r=this.minlng,i=this.minlat,o=this.maxlng,a=this.maxlat;return!!(r<=e&&e<=o&&i<=n&n<=a)},t.isRecCross=function(t,e){var n=t.x,r=t.y,i={minx:n-e/2,miny:r-e/2,maxx:n+e/2,maxy:r+e/2},o=i.minx,a=i.miny,s=i.maxx,c=i.maxy;return!!(ce(this,[o,a])||ce(this,[o,c])||ce(this,[s,a])||ce(this,[s,c])||ce(i,[this.minx,this.miny])||ce(i,[this.minx,this.maxy])||ce(i,this.maxx,this.miny)||ce(i,this.maxx,this.maxy))},f.initGrids=function(t,e,n,r){for(var i,o,a=[],s=(n-t)/30,c=(r-e)/30,u=0;u<30;u++){i=t+u*s;for(var h=0;h<30;h++){var l=new f(i,o=e+h*c,i+s,o+c);l.key=h+"-"+u,a.push(l)}}return a},f}(),he={altitude:0},le=new ht.Vector3,fe=function(V){function t(t,e,n,r){var i;Array.isArray(t)||(t=[t]),e=ut.Util.extend({},he,e,{layer:r,points:t});for(var o=1/0,a=1/0,s=-1/0,c=-1/0,u=0,h=t.length;u<h;u++){var l=t[u].coordinate,f=void 0,d=void 0;Array.isArray(l)?(f=l[0],d=l[1]):l instanceof ut.Coordinate&&(f=l.x,d=l.y),o=Math.min(o,f),a=Math.min(a,d),s=Math.max(s,f),c=Math.max(c,d)}for(var v=r.coordinateToVector3([(o+s)/2,(a+c)/2]),p=ue.initGrids(o,a,s,c),g=p.length,x=[],y=[],m=[],b=[],_=[],w=0,M=t.length;w<M;w++){var j=t[w],O=j.coordinate,S=j.height,A=j.color;A&&(A=A instanceof ht.Color?A:new ht.Color(A),m.push(A.r,A.g,A.b));var C=r.distanceToVector3(S,S).x,T=r.coordinateToVector3(O,C),k=T.clone().sub(v);x.push(k.x,k.y,k.z),y.push(T),_[w]={position:{count:1,start:3*w,end:3*w+3},hide:!1};for(var B=0;B<g;B++)if(p[B].containsCoordinate(O)){p[B].positions.push(T),p[B].indexs.push(w);break}}var z=new ht.BufferGeometry;lt(z,"position",new ht.Float32BufferAttribute(x,3,!0)),m.length&&lt(z,"color",new ht.Float32BufferAttribute(m,3,!0)),e.positions=y,(i=V.call(this)||this)._initOptions(e),i._createPoints(z,n);var I=e.altitude,P=r.distanceToVector3(I,I).x,L=v.clone();return L.z=P,i.getObject3d().position.copy(L),i._baseObjects=b,i._datas=t,i.faceIndex=null,i._geometriesAttributes=_,i._geometryCache=z.clone(),i.isHide=!1,i._initBaseObjectsEvent(b),i._grids=p,i._bindMapEvents(),i}i(t,V);var e=t.prototype;return e._bindMapEvents=function(){var t=this,e=this.getMap();this.on("add",function(){t._updateGrids(),e.on("zoomstart zooming zoomend movestart moving moveend pitch rotate",t._updateGrids,t)}),this.on("remove",function(){e.off("zoomstart zooming zoomend movestart moving moveend pitch rotate",t._updateGrids,t)})},e._updateGrids=function(){var e=this.getMap();this._grids.forEach(function(t){t.indexs.length&&t.updateBBoxPixel(e)})},e.getSelectMesh=function(){var t,e,n,r,i=this.faceIndex;if(null!=i)return this._baseObjects[i]||(e=(t=this._datas[i]).coordinate,n=t.height,r=t.color,this._baseObjects[i]=new se(e,{height:n,index:i,color:r},this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[i])),{data:this._datas[i],baseObject:this._baseObjects[i]}},e.identify=function(t){var e=this.getLayer(),n=this.getMap().getSize(),r=this.getLayer().getCamera(),i=this.getOptions().altitude,o=this.getMap(),a=e.distanceToVector3(i,i).x,s=this.getObject3d().material.size,c=o.coordToContainerPoint(t),u=[];if(this._grids.forEach(function(t){t.indexs.length&&t.isRecCross(c,s)&&u.push(t)}),u.length<1)return!1;for(var h=0,l=u.length;h<l;h++)for(var f=0,d=u[h].positions.length;f<d;f++){var v=u[h].positions[f];le.x=v.x,le.y=v.y,le.z=v.z+a;var p=ie(le,n,r);if(Math.sqrt(Math.pow(c.x-p.x,2)+Math.pow(c.y-p.y,2))<=s/2)return this.faceIndex=u[h].indexs[f],!0}return!1},t}(Qt(p)),de={coordinate:null,radius:10,height:100,radialSegments:6,altitude:0,topColor:null,bottomColor:"#2d2f61"},ve=function(E){function t(t,e,n,r){var i;Array.isArray(t)||(t=[t]);for(var o=t.length,a=[],s=[],c=[],u=[],h=0,l=0,f=0,d=0,v=0;v<o;v++){var p=ut.Util.extend({index:v},de,t[v]),g=p.radius,x=p.radialSegments,y=p.altitude,m=p.topColor,b=p.bottomColor,_=p.height,w=p.coordinate,M=r.distanceToVector3(g,g).x,j=r.distanceToVector3(_,_).x,O=r.distanceToVector3(y,y).x,S=R({radius:M,height:j,radialSegments:x},!1);m&&!n.map&&(F(S,b,m,"z",j/2),n.vertexColors=ht.VertexColors);for(var A=r.coordinateToVector3(w),C=S.attributes.position.array,T=0,k=C.length;T<k;T+=3)C[T+2]+=O,C[T]+=A.x,C[T+1]+=A.y,C[T+2]+=A.z;a.push(S);var B=new Z(w,p,n,r);s.push(B);var z=S.index.count/3;u[v]=[h+1,h+z],h+=z;var I=S.attributes.position.count,P=S.attributes.normal.count,L=S.attributes.uv.count;c[v]={position:{count:I,start:l,end:l+3*I},normal:{count:P,start:f,end:f+3*P},uv:{count:L,start:d,end:d+2*L},hide:!1},l+=3*I,f+=3*P,d+=2*L}i=E.call(this)||this,e=ut.Util.extend({},{altitude:0,layer:r,points:t},e),i._initOptions(e);var V=function(t){for(var e=[],n=[],r=0,i=t.length;r<i;r++){var o=t[r].attributes,a=o.color,s=o.normal,c=o.position,u=o.uv,h=t[r].index;if(a)for(var l=0,f=a.array.length;l<f;l++)n.push(a.array[l]);e.push({normal:s.array,uv:u.array,position:c.array,indices:h.array})}var d=U(e);if(n.length)for(var v=0,p=n.length;v<p;v++)d.attributes.color.array[v]=n[v];return d}(a);return i._createMesh(V,n),i._faceMap=u,i._baseObjects=s,i._datas=t,i._geometriesAttributes=c,i.faceIndex=null,i._geometryCache=V.clone(),i.isHide=!1,i._colorMap={},i._initBaseObjectsEvent(s),i._setPickObject3d(),i._init(),i}i(t,E);var e=t.prototype;return e.getSelectMesh=function(){var t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}},e._getIndex=function(t){return null==t&&(t=this.faceIndex||this.index),t},e._init=function(){var t=this,e=this.getLayer().getPick();this.on("add",function(){e.add(t.pickObject3d)}),this.on("remove",function(){e.remove(t.pickObject3d)})},e._setPickObject3d=function(){for(var t=this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),n=this._geometriesAttributes,r=[],i=0,o=n.length;i<o;i++){var a=e.getColor(),s=a.getHex(),c=n[this._colorMap[s]=i].position.count;this._datas[i].colorIndex=s;for(var u=0;u<c;u++)r.push(a.r,a.g,a.b)}lt(t,"color",new ht.Float32BufferAttribute(r,3,!0));var h=new ht.MeshBasicMaterial;h.vertexColors=ht.VertexColors;var l=e.getColor().getHex(),f=new ht.Mesh(t,h);f.position.copy(this.getObject3d().position),f._colorIndex=l,this.setPickObject3d(f)},e.identify=function(){return this.picked},t}(Qt(p)),pe={width:3,height:1,altitude:0},ge=function(I){function t(t,e,n,r){var i;Array.isArray(t)||(t=[t]);for(var o=[],a=t.length,s=0;s<a;s++){var c=t[s];o.push(bt(c)?jt(c):c.getCenter())}for(var u=Vt(o),h=[],l=[],f=0,d=[],v=[],p=0,g=0,x=0;x<a;x++){var y=t[x],m=ut.Util.extend({},pe,bt(y)?y.properties:y.getProperties(),{index:x}),b=m.height,_=m.width,w=Tt(y,r.distanceToVector3(_,_).x,r.distanceToVector3(b,b).x,r,u);h.push(w);var M=new It(y,m,n,r);l.push(M);var j=w.position,O=w.normal,S=w.indices.length/3;d[x]=[f+1,f+S],f+=S;var A=j.length/3,C=O.length/3;v[x]={position:{count:A,start:p,end:p+3*A},normal:{count:C,start:g,end:g+3*C},hide:!1},p+=3*A,g+=3*C}var T=U(h);e=ut.Util.extend({},pe,e,{layer:r,lineStrings:t,coordinate:u}),(i=I.call(this)||this)._initOptions(e),i._createMesh(T,n);var k=e.altitude,B=r.distanceToVector3(k,k).x,z=r.coordinateToVector3(u,B);return i.getObject3d().position.copy(z),i._faceMap=d,i._baseObjects=l,i._datas=t,i._geometriesAttributes=v,i.faceIndex=null,i._geometryCache=T.clone(),i.isHide=!1,i._colorMap={},i._initBaseObjectsEvent(l),i._setPickObject3d(),i._init(),i}i(t,I);var e=t.prototype;return e.getSelectMesh=function(){var t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}},e._getIndex=function(t){return null==t&&(t=this.faceIndex||this.index),t},e._init=function(){var t=this,e=this.getLayer().getPick();this.on("add",function(){e.add(t.pickObject3d)}),this.on("remove",function(){e.remove(t.pickObject3d)})},e._setPickObject3d=function(){for(var t=this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),n=this._geometriesAttributes,r=[],i=0,o=n.length;i<o;i++){var a=e.getColor(),s=a.getHex(),c=n[this._colorMap[s]=i].position.count;this._datas[i].colorIndex=s;for(var u=0;u<c;u++)r.push(a.r,a.g,a.b)}lt(t,"color",new ht.Float32BufferAttribute(r,3,!0));var h=new ht.MeshBasicMaterial;h.vertexColors=ht.VertexColors;var l=e.getColor().getHex(),f=new ht.Mesh(t,h);f.position.copy(this.getObject3d().position),f._colorIndex=l,this.setPickObject3d(f)},e.identify=function(){return this.picked},t}(Qt(p)),xe={altitude:0,colors:null},ye=function(A){function t(t,e,n,r){var i;Array.isArray(t)||(t=[t]);for(var o=[],a=t.length,s=0;s<a;s++){var c=t[s];o.push(wt(c)?jt(c):c.getCenter())}var u=Vt(o);e=ut.Util.extend({},xe,e,{layer:r,lineStrings:t,coordinate:u});for(var h=[],l=0,f=[],d=[],v=0,p=[],g=0;g<a;g++){for(var x=At(t[g],r,u).positionsV,y=0,m=x.length;y<m;y++){var b=x[y];0<y&&y<m-1&&p.push(b.x,b.y,b.z),p.push(b.x,b.y,b.z)}var _=x.length+x.length-2,w=_;f[g]=[l,l+w],l+=w,d[g]={position:{count:_,start:v,end:v+3*_},hide:!1},v+=3*_}var M=new ht.BufferGeometry;lt(M,"position",new ht.Float32BufferAttribute(p,3)),(i=A.call(this)||this)._initOptions(e),i._createLineSegments(M,n);var j=e.altitude,O=r.distanceToVector3(j,j).x,S=r.coordinateToVector3(u,O);return i.getObject3d().position.copy(S),i._faceMap=f,i._baseObjects=h,i._datas=t,i._geometriesAttributes=d,i.faceIndex=null,i.index=null,i._geometryCache=M.clone(),i.isHide=!1,i._colorMap={},i._initBaseObjectsEvent(h),i._setPickObject3d(),i._init(),i}i(t,A);var e=t.prototype;return e.getSelectMesh=function(){var t,e,n=this._getIndex();if(null!=n)return this._baseObjects[n]||(t=this._datas[n],e=ut.Util.extend({},this.getOptions(),{index:n},wt(t)?t.properties:t.getProperties()),this._baseObjects[n]=new Bt(t,e,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[n])),{data:this._datas[n],baseObject:this._baseObjects[n]}},e._getIndex=function(t){return null==t&&(t=this.faceIndex||this.index),t},e._init=function(){var t=this,e=this.getLayer().getPick();this.on("add",function(){e.add(t.pickObject3d)}),this.on("remove",function(){e.remove(t.pickObject3d)})},e._setPickObject3d=function(){for(var t=this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),n=this._geometriesAttributes,r=[],i=0,o=n.length;i<o;i++){var a=e.getColor(),s=a.getHex(),c=n[this._colorMap[s]=i].position.count;this._datas[i].colorIndex=s;for(var u=0;u<c;u++)r.push(a.r,a.g,a.b)}lt(t,"color",new ht.Float32BufferAttribute(r,3,!0));var h=this.getObject3d().material.clone();h.color.set("#fff"),h.vertexColors=ht.VertexColors;var l=e.getColor().getHex(),f=new ht.LineSegments(t,h);f.position.copy(this.getObject3d().position),f._colorIndex=l,this.setPickObject3d(f)},e.identify=function(){return this.picked},t}(Qt(p)),me=[],be=[];function _e(t,e){for(var n=0,r=t.length;n<r;n++){var i=t[n];if(i){var o=i.key,a=i.callback;if(e===o)return t.splice(n,1),a}}return null}var we=document.createElement("canvas");function Me(t,e){var n,r=we.getContext("2d");return r.clearRect(0,0,256,256),r.save(),e&&(r.fillStyle="red",r.strokeStyle="rgba(255,0,0,0.4)",r.lineWidth=.2,n=t||"tile",r.font="18px sans-serif",r.rect(0,0,256,256),r.stroke(),r.fillText(n,15,128)),we.toDataURL()}function je(t,e){var n;return void 0===t&&(t=1),void 0===e&&(e=1),"undefined"==typeof document||(n=document.createElement("canvas"),t&&(n.width=t),e&&(n.height=e)),n}we.width=we.height=256;var Oe=function(r){function t(t,e){var n;return void 0===e&&(e={}),(n=r.call(this,ut.Util.GUID(),ut.Util.extend({urlTemplate:t},e))||this)._opts=null,n._layer=null,n.material=null,n.getMaterial=null,n._baseObjectKeys={},n._loadTiles={},n._add=null,n._layerLaodTime=(new Date).getTime(),n}i(t,r);var e=t.prototype;return e.isAsynchronous=function(){return this._opts.worker},e.getBaseObjects=function(){var t=this._loadTiles,e=[];for(var n in t){var r=this._baseObjectKeys[n];if(r&&Array.isArray(r)&&r.length)for(var i=0,o=r.length;i<o;i++)e.push(r[i])}return e},e.onSelectMesh=function(){},e.formatBaseObjects=function(){},e.loopMessage=function(){},e.getTileData=function(t){var n=t.key,e=t.url,r=t.callback,i=t.img;ut.Ajax.getJSON(e,{},function(t,e){t?(console.error(t),r(n,null,i)):r(n,e,i)})},e._getCurentTileKeys=function(){for(var t=this.getTiles().tileGrids||[],e=[],n={},r=0,i=t.length;r<i;r++)for(var o=t[r].tiles||[],a=0,s=o.length;a<s;a++){var c=o[a].dupKey;e.push(c),n[c]=!0}return{keys:e,keysMap:n}},e._isLoad=function(){var t=this._getCurentTileKeys().keys,e=Object.keys(this._renderer.tilesInView);return t.length===e.length},e._layerOnLoad=function(){var t=(new Date).getTime();if(!(t-this._layerLaodTime<20)){this._layerLaodTime=t;var e,n,r,i,o,a=this._renderer.tilesInView,s=this._loadTiles,c=this._layer,u=this._baseObjectKeys,h=Object.keys(a).length,l=Object.keys(s).length,f=[];if(h&&l)for(var d in s)a[d]||u[d]&&(u[d]||[]).forEach(function(t){f.push(t)});if(f.length&&c.removeMesh(f,!1),h&&l)for(var v in a){s[v]||(u[v]?(e=u[v],c.addMesh(e)):(r=(n=this._getXYZOfIndex(v)).x,i=n.y,o=n.z,this.getTileUrl(r,i,o)))}this._loadTiles=Object.assign({},a),this._diffCache()}},e._init=function(){},e._workerLoad=function(t){var e=t.target._img;e.currentCount++,e.currentCount===e.needCount&&(e.src=Me(e._key,this._opts.debug))},e._generateBaseObjects=function(t,e,n){var r=this;if(e&&n){if(!this._getCurentTileKeys().keysMap[t])return void(n.src=Me(t,this._opts.debug));var i=this.formatBaseObjects(t,e);if(i.length){n.needCount=i.length;for(var o=n.currentCount=0,a=i.length;o<a;o++){var s=i[o];s._img=n,(s._vt=this).isVisible()||s.hide(),this._cachetile(t,s),s.isAsynchronous()||n.currentCount++}this._layer.addMesh(i,!1),n.needCount===n.currentCount&&(n.src=Me(t,this._opts.debug)),this.isAsynchronous()?i.filter(function(t){return t.isAsynchronous()}).forEach(function(t){t.on("workerload",r._workerLoad,r)}):n.src=Me(t,this._opts.debug)}else n.src=Me(t,this._opts.debug);this._loadTiles[t]=!0}else n&&(n.src=Me(t,this._opts.debug))},e._diffCache=function(){var i=this;Object.keys(this._baseObjectKeys).length>this._renderer.tileCache.max&&function(){var t=i._renderer.tileCache.data,e=i._renderer.tilesInView,n=[];for(var r in i._baseObjectKeys)t[r]||e[r]||((i._baseObjectKeys[r]||[]).forEach(function(t){t.isAdd&&n.push(t)}),i._diposeBaseObject(r),delete i._baseObjectKeys[r]);n.length&&i._layer.removeMesh(n,!1)}()},e._diposeBaseObject=function(t){var e=this._baseObjectKeys[t];e&&e.length&&e.forEach(function(t){t.getObject3d().geometry.dispose(),t._geometryCache&&t._geometryCache.dispose();var e=t._baseObjects;e&&e.length&&e.forEach(function(t){t.getObject3d().geometry.dispose(),t=null}),t._datas=null,t._geometriesAttributes=null,t._faceMap=null,t=null})},e._cachetile=function(t,e){this._baseObjectKeys[t]||(this._baseObjectKeys[t]=[]),this._baseObjectKeys[t].push(e)},e._getXYZOfIndex=function(t){var e=-1<t.indexOf("_")?"_":"-",n=t.split(e).slice(1,4),r=n[0],i=n[1],o=n[2];return{x:i=parseInt(i),y:r=parseInt(r),z:o=parseInt(o)}},e._getTileExtent=function(t,e,n){var r=this.getMap()._getResolution(n);return this._getTileConfig().getTilePrjExtent(t,e,r)},e._getTileLngLatExtent=function(t,e,n){var r=this._getTileExtent(t,e,n),i=r.getMax(),o=r.getMin(),a=this.getMap().getProjection(),o=a.unproject(o),i=a.unproject(i);return new ut.Extent(o,i)},t}(ut.TileLayer),Se={worker:!1},Ae=function(o){function t(t,e,n,r){var i;return void 0===e&&(e={}),(i=o.call(this,ut.Util.GUID(),ut.Util.extend({urlTemplate:t},Se,e))||this)._opts=e,i._layer=r,i.getMaterial=n,i._baseObjectKeys={},i._loadTiles={},i._add=null,i._layerLaodTime=(new Date).getTime(),i._init(),i}i(t,o);var e=t.prototype;return e.formatBaseObjects=function(t,e){var n=this._opts,r=[],i=this.isAsynchronous();for(var o in e){var a=e[o]||{},s=void 0;if(Array.isArray(a)?s=a:"FeatureCollection"===a.type&&(s=a.features),s&&s.length){for(var c,u,h,l,f,d,v=[],p=[],g=[],x=0,y=s.length;x<y;x++){var m=s[x];if(_t(m))v.push(m);else if(wt(m))for(var b=Ot(m),_=0,w=b.length;_<w;_++)p.push(b[_]);else if(function(t){void 0===t&&(t={});var e=mt(t);return!(!e||e!==yt[0]&&e!==yt[1])}(m))for(var M=Ot(m),j=0,O=M.length;j<O;j++)g.push(ut.Util.extend({},M[j].properties,M[j],{coordinate:Mt(M[j])}))}!v.length||(c=this._getMaterial(o,v,t,a))&&(u=this._layer.toExtrudePolygons(v,ut.Util.extend({},{topColor:"#fff",layerName:o,asynchronous:i,key:t},n),c),r.push(u)),!p.length||(h=this._getMaterial(o,p,t,a))&&(h instanceof ht.LineBasicMaterial||h instanceof ht.LineDashedMaterial)&&(l=this._layer.toLines(p,ut.Util.extend({},{layerName:o},n),h),r.push(l)),!g.length||(f=this._getMaterial(o,g,t,a))&&f instanceof ht.PointsMaterial&&(d=this._layer.toPoints(g,ut.Util.extend({},{layerName:o},n),f),r.push(d))}}return r},e.loopMessage=function(t){0<{waitingQueue:me,currentQueue:be}.currentQueue.length&&this.getTileData(t)},e._init=function(){var o=this;this.on("layerload",this._layerOnLoad),this.on("add",function(){var t;!1===o._add&&(t=o.getBaseObjects(),o._layer.addMesh(t)),o._add=!0,o.intervalId=setInterval(function(){o._isLoad()&&!o._layer.getMap().isInteracting()&&o.fire("layerload")},1e3)}),this.on("remove",function(){o._add=!1;var t=o.getBaseObjects();o._layer.removeMesh(t),clearInterval(o.intervalId)}),this.on("show",function(){var t=o.getBaseObjects();for(var e in t.forEach(function(t){t.show()}),o._baseObjectKeys){(o._baseObjectKeys[e]||[]).forEach(function(t){t.show()})}}),this.on("hide",function(){var t=o.getBaseObjects();for(var e in t.forEach(function(t){t.hide()}),o._baseObjectKeys){(o._baseObjectKeys[e]||[]).forEach(function(t){t.hide()})}}),this.on("renderercreate",function(t){t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.dupKey),n},t.renderer.deleteTile=function(t){var e,n,r;t&&t.image&&(t.image.onload=null,t.image.onerror=null,e=t.info||{},(r=_e(me,n=e.dupKey))&&r(n))},t.renderer.loadTileImage=function(t,e,n){var r,i;t._key=n,i={key:n,url:e,callback:function(t,e,n){var r,i;o._generateBaseObjects(t,e,n),r=o,_e(be,t),me.length&&(be.push(me[0]),me.splice(0,1),i=be[be.length-1],r.loopMessage(i))},img:t,vt:r=o},be.length<10?(be.push(i),r.loopMessage(i)):me.push(i)}})},e._getMaterial=function(t,e,n,r){return this.getMaterial&&ut.Util.isFunction(this.getMaterial)?this.getMaterial(t,e,n,r):null},t}(Oe),Ce=new ht.TextureLoader,Te=document.createElement("canvas"),ke=256;function Be(t){return t?("string"==typeof t?(e=new Image).src=t:t instanceof HTMLCanvasElement?(e=new Image).src=t.toDataURL():t instanceof Image&&((e=new Image).src=t.src,e.crossOrigin=t.crossOrigin),e&&!e.crossOrigin&&(e.crossOrigin="Anonymous"),e):null;var e}var ze={interactive:!1,altitude:0,image:null,imageWidth:256,imageHeight:256,texture:null},Ie=function(O){function t(t,e,a,s){var n=(e=ut.Util.extend({},ze,e,{layer:s,extent:t})).texture,r=e.image,i=e.altitude,c=e.imageHeight,u=e.imageWidth;r||console.error("not find image"),t instanceof ut.Extent||(t=new ut.Extent(t));var o=t.xmin,h=t.ymin,l=t.xmax,f=t.ymax,d=1/0,v=1/0,p=-1/0,g=-1/0;[[o,h],[o,f],[l,f],[l,h]].forEach(function(t){var e=s.coordinateToVector3(t),n=e.x,r=e.y;d=Math.min(n,d),v=Math.min(r,v),p=Math.max(n,p),g=Math.max(r,g)});var x,y=Math.abs(p-d),m=Math.abs(g-v),b=Be(r),_=Be(n),w=new ht.PlaneBufferGeometry(y,m,u-1,c-1);(x=O.call(this)||this)._initOptions(e),x._createMesh(w,a);var M=s.distanceToVector3(i,i).x,j=s.coordinateToVector3(t.getCenter(),M);return x.getObject3d().position.copy(j),a.transparent=!0,b&&(a.opacity=0,b.onload=function(){for(var t=function(t,e,n){void 0===e&&(e=ke),void 0===n&&(n=ke),Te.width=e,Te.height=n;var r=Te.getContext("2d");return r.drawImage(t,0,0,e,n),r.getImageData(0,0,e,n).data}(b,u,c),e=0,n=0,r=t.length;n<r;n+=4){var i=.1*(256*t[n]*256+256*t[n+1]+t[n+2])-1e4,o=s.distanceToVector3(i,i).x;w.attributes.position.array[3*e+2]=o,e++}w.attributes.position.needsUpdate=!0,_?Ce.load(_.src,function(t){a.map=t,a.opacity=1,a.needsUpdate=!0}):a.opacity=1},b.onerror=function(){console.error("not load "+b.src)}),x}return i(t,O),t}(p),Pe={scale:1},Le=function(o){function t(t,e,n,r){var i;return void 0===e&&(e={}),(i=o.call(this,ut.Util.GUID(),ut.Util.extend({urlTemplate:t},Pe,e))||this)._opts=e,i._layer=r,i.material=n,i._baseObjectKeys={},i._loadTiles={},i._add=null,i._imgQueue={},i._layerLaodTime=(new Date).getTime(),i._init(),i}i(t,o);var e=t.prototype;return e.isAsynchronous=function(){return!1},e.formatBaseObjects=function(t,e){var n,r=[],i=this.options.scale,o=this._getXYZOfIndex(t),a=o.x,s=o.y,c=o.z,u=this.getMap().getZoom(),h=this.getTileUrl(a,s,c),l=this.options.tileSize,f=l[0],d=l[1],v=this._getTileLngLatExtent(a,s,c),p=this.material.clone();return c+1>=Math.round(u)&&((n=new Ie(v,{image:e,imageWidth:f/8,imageHeight:d/8,texture:h},p,this._layer)).getObject3d().scale.set(i,i,1),r.push(n)),r},e.loopMessage=function(t){this.getTileData(t)},e._init=function(){var o=this;this.on("layerload",this._layerOnLoad),this.on("add",function(){var t;!1===o._add&&(t=o.getBaseObjects(),o._layer.addMesh(t)),o._add=!0,o.intervalId=setInterval(function(){o._isLoad()&&!o._layer.getMap().isInteracting()&&o.fire("layerload")},1e3)}),this.on("remove",function(){o._add=!1;var t=o.getBaseObjects();o._layer.removeMesh(t),clearInterval(o.intervalId)}),this.on("show",function(){var t=o.getBaseObjects();for(var e in t.forEach(function(t){t.show()}),o._baseObjectKeys){(o._baseObjectKeys[e]||[]).forEach(function(t){t.show()})}}),this.on("hide",function(){var t=o.getBaseObjects();for(var e in t.forEach(function(t){t.hide()}),o._baseObjectKeys){(o._baseObjectKeys[e]||[]).forEach(function(t){t.hide()})}}),this.on("renderercreate",function(t){t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.dupKey),n},t.renderer.deleteTile=function(t){var e,n;t&&t.image&&(t.image.onload=null,t.image.onerror=null,e=t.info||{},(n=o._imgQueue[e.dupKey])&&(n.src="",n.onload=null,n.onerror=null,delete o._imgQueue[e.dupKey]))},t.renderer.loadTileImage=function(t,e,n){t._key=n;var r=new Image,i={key:n,url:e,rgbImage:o._imgQueue[n]=r,callback:function(t,e,n){o._generateBaseObjects(t,e,n)},img:t,vt:o};o.loopMessage(i)}})},t}(Oe);function Ve(t){t=t||{},this.gradient=t.gradient||{.25:"rgba(0, 0, 255, 1)",.55:"rgba(0, 255, 0, 1)",.85:"rgba(255, 255, 0, 1)",1:"rgba(255, 0, 0, 1)"},this.maxSize=t.maxSize||35,this.minSize=t.minSize||0,this.max=t.max||100,this.min=t.min||0,this.initPalette()}function Ee(t,e,n){var r=Ue(n),i=n.min||0,o=r-i,a=n.range||null,s=0,c=1024;a&&2===a.length&&(s=(a[0]-i)/o*1024),a&&2===a.length&&(c=(a[1]-i)/o*1024);for(var u,h=n.maxOpacity||.8,l=n.minOpacity||0,f=3,d=t.length;f<d;f+=4)u=4*t[f],t[f]/256>h&&(t[f]=256*h),t[f]/256<l&&(t[f]=256*l),u&&s<=u&&u<=c?(t[f-3]=e[u],t[f-2]=e[1+u],t[f-1]=e[2+u]):t[f]=0}function Ue(t){return t.max||100}function Re(r,t,e){var n,i,o,a,s,c,u=Ue(e),h=e._size||e.size||13,l=(a=new je(2*(o=(n=h)+(i=n/2)),2*o),(s=a.getContext("2d")).shadowBlur=i,s.shadowColor="black",s.shadowOffsetX=s.shadowOffsetY=1e4,s.beginPath(),s.arc(o-1e4,o-1e4,n,0,2*Math.PI,!0),s.closePath(),s.fill(),a),f=l.width/2,d=l.height/2,v=t,p={};for(var g in v.forEach(function(t){var e=void 0===t.count?1:t.count,n=Math.min(1,e/u).toFixed(2);p[n]=p[n]||[],p[n].push(t)}),p){isNaN(g)||(c=p[g],r.beginPath(),e.withoutAlpha||(r.globalAlpha=g),c.forEach(function(t){var e=t.coordinate,n=void 0===t.count?1:t.count;r.globalAlpha=n/u,r.drawImage(l,e[0]-f,e[1]-d)}))}}Ve.prototype.setMax=function(t){this.max=t||100},Ve.prototype.setMin=function(t){this.min=t||0},Ve.prototype.setMaxSize=function(t){this.maxSize=t||35},Ve.prototype.setMinSize=function(t){this.minSize=t||0},Ve.prototype.initPalette=function(){var t=this.gradient,e=new je(256,1),n=this.paletteCtx=e.getContext("2d"),r=n.createLinearGradient(0,0,256,1);for(var i in t)r.addColorStop(parseFloat(i),t[i]);n.fillStyle=r,n.fillRect(0,0,256,1)},Ve.prototype.getColor=function(t){var e=this.getImageData(t);return"rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]/256+")"},Ve.prototype.getImageData=function(t){var e=this.paletteCtx.getImageData(0,0,256,1).data;if(void 0===t)return e;var n=this.max,r=this.min;n<t&&(t=n),t<r&&(t=r);var i=4*Math.floor((t-r)/(n-r)*255);return[e[i],e[1+i],e[2+i],e[3+i]]},Ve.prototype.getSize=function(t){var e=this.max,n=this.min,r=this.maxSize,i=this.minSize;return e<t&&(t=e),t<n&&(t=n),n<e?i+(t-n)/(e-n)*(r-i):r};var Fe={draw:function(t,e,n){var r,i,o,a;t.canvas.width<=0||t.canvas.height<=0||(r=n.strength||.3,t.strokeStyle="rgba(0,0,0,"+r+")",(i=new je(t.canvas.width,t.canvas.height).getContext("2d")).scale(devicePixelRatio,devicePixelRatio),n=n||{},t.save(),o=new Ve({gradient:n.gradient}),Re(i,e,n),n.absolute||(Ee((a=i.getImageData(0,0,t.canvas.width,t.canvas.height)).data,o.getImageData(),n),t.putImageData(a,0,0),t.restore()),o=null)},drawGray:Re,colorize:Ee},Ze={interactive:!(Ve.prototype.getLegend=function(t){var e=this.gradient,n=t.width||20,r=t.height||180,i=new je(n,r),o=i.getContext("2d"),a=o.createLinearGradient(0,r,0,0);for(var s in e)a.addColorStop(parseFloat(s),e[s]);return o.fillStyle=a,o.fillRect(0,0,n,r),i}),min:0,max:100,size:13,gradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},gridScale:.5},Ge=function(ct){function t(t,e,n,r){var i;Array.isArray(t)||(t=[t]);for(var o=1/0,a=1/0,s=-1/0,c=-1/0,u=[],h=0,l=t.length;h<l;h++){var f,d,v,p=t[h],g=p.coordinate,x=p.lnglat,y=p.xy,m=g||x||y;m?(f=r.coordinateToVector3(m),u.push(f),d=f.x,v=f.y,o=Math.min(o,d),a=Math.min(a,v),s=Math.max(s,d),c=Math.max(c,v)):console.warn("not find coordinate")}var b=(e=ut.Util.extend({},Ze,e,{layer:r,points:t})).gridScale,_=e.altitude,w=Math.abs(s-o),M=Math.abs(c-a),j=Math.max(w*b,M*b);2048<j&&(console.warn("gridScale: "+b+" it's too big. I hope it's a smaller value,canvas max size is 2048* 2048"),b=2048/(j/b));for(var O=Math.ceil(w*b),S=Math.ceil(M*b),A=O/w,C=S/M,T=[],k=0,B=u.length;k<B;k++){var z=u[k];z.x-=o,z.y-=a,z.x*=A,z.y*=C,z.y=S-z.y,T.push({coordinate:[z.x,z.y],count:t[k].count})}var I=new je(O,S).getContext("2d");Fe.drawGray(I,T,e);for(var P=I.getImageData(0,0,I.canvas.width,I.canvas.height),L=-1/0,V={},E=[],U=3,R=P.data.length,F=0;U<R;U+=4){var Z=P.data[U],L=Math.max(L,Z);E.push(Z),Z<=0&&(V[F]=1),F++}var G=new Ve({gradient:e.gradient});Fe.colorize(P.data,G.getImageData(),e),I=null;for(var D,W,H,q,K,N=new ht.PlaneBufferGeometry(w,M,O-1,S-1),Q=N.getIndex().array,X=N.attributes.position.array,Y=[],J=[],$=new ht.Color,tt=0,et=X.length,nt=0,rt=Q.length,it=0,ot=P.data.length,at=0;tt<Math.max(et,rt,ot);tt+=3){tt<et&&(0<(D=E[at])&&(X[tt+2]=D/L)),nt<rt&&(W=Q[nt],H=Q[nt+1],q=Q[nt+2],V[W]&&V[H]&&V[q]||Y.push(W,H,q)),it<ot&&(K="rgb("+P.data[it]+","+P.data[it+1]+","+P.data[it+2]+")",$.setStyle(K),J.push($.r,$.g,$.b)),nt+=3,it+=4,at++}N.setIndex(new ht.Uint32BufferAttribute(Y,1)),lt(N,"color",new ht.Float32BufferAttribute(J,3,!0)),n.vertexColors=ht.VertexColors,(i=ct.call(this)||this)._initOptions(e),i._createMesh(N,n);var st=r.distanceToVector3(_,_).x;return i.getObject3d().position.copy(new ht.Vector3((o+s)/2,(a+c)/2,st)),i}return i(t,ct),t}(p),De=new ht.Color,We=1,He=function(){function t(t){this.object3ds=[],this.layer=t,this.camera=t.getCamera(),this.renderer=t.getThreeRenderer(),this.pickingTexture=new ht.WebGLRenderTarget(1,1),this.pickingScene=new ht.Scene}var e=t.prototype;return e.getColor=function(){return De.setHex(We),We++,De},e.add=function(t){var e;return!t||(e=t._colorIndex)&&(this.object3ds[e]=t,this.pickingScene.add(t)),this},e.remove=function(t){var e;return!t||(e=t._colorIndex)&&(this.object3ds[e]=null,this.pickingScene.remove(t)),this},e.isEmpty=function(){if(0===this.pickingScene.children.length)return!0;for(var t=0,e=this.pickingScene.children.length;t<e;t++){var n=this.pickingScene.children[t];if(n){var r=n.__parent;if(r&&!0===r.getOptions().interactive)return!1}}return!0},e.pick=function(t){if(t&&!this.isEmpty()){for(var e=this.camera,n=this.renderer,r=this.pickingTexture,i=this.pickingScene,o=this.object3ds,a=this.layer,s=this.pickingScene.children.length,c=0;c<s;c++){var u=this.pickingScene.children[c];u&&u.__parent&&(u.__parent.picked=!1)}var h=a._getRenderer().canvas,l=h.width,f=h.height,d=r.width,v=r.height;l===d&&f===v||r.setSize(l,f),n.setRenderTarget(r),n.clear(),n.render(i,e);var p=new Uint8Array(4),g=t.x,x=t.y,y=window.devicePixelRatio,m=g*y,b=r.height-x*y;n.readRenderTargetPixels(r,Math.round(m),Math.round(b),1,1,p);var _=p[0]<<16|p[1]<<8|p[2],w=o[_];if(w)w.__parent&&(o[_].__parent.picked=!0);else for(var M=0;M<s;M++){var j=this.pickingScene.children[M];if(j&&j.__parent){var O=j.__parent;if(O._colorMap&&null!=O._colorMap[_]){O.picked=!0,O.index=O._colorMap[_];break}}}n.setRenderTarget(null)}},t}(),qe={altitude:0},Ke=function(p){function t(t,e,n,r){var i;e=ut.Util.extend({},qe,e,{layer:r,lineString:t}),(i=p.call(this)||this)._initOptions(e);for(var o=bt(t)?jt(t):t.getCenter(),a=At(t,r,o).positionsV,s=[],c=0,u=a.length;c<u;c++){var h=a[c];0<c&&c<u-1&&s.push(h.x,h.y,h.z),s.push(h.x,h.y,h.z)}var l=new C;l.setPositions(s),i._setMaterialRes(r,n),i._createLine2(l,n);var f=e.altitude,d=r.distanceToVector3(f,f).x,v=r.coordinateToVector3(o,d);return i.getObject3d().position.copy(v),i._setPickObject3d(s,n.linewidth),i._init(),i}i(t,p);var e=t.prototype;return e._init=function(){var t=this,e=this.getLayer().getPick();this.on("add",function(){e.add(t.pickObject3d)}),this.on("remove",function(){e.remove(t.pickObject3d)})},e._setMaterialRes=function(t,e){var n=t.getMap().getSize(),r=n.width,i=n.height;e.resolution.set(r,i)},e._setPickObject3d=function(t,e){var n=new C;n.setPositions(t);for(var r=this.getLayer().getPick().getColor(),i=[],o=0,a=t.length/3;o<a;o++)i.push(r.r,r.g,r.b);n.setColors(i);var s=new g({color:"#fff",linewidth:e,vertexColors:ht.VertexColors});this._setMaterialRes(this.getLayer(),s);var c=r.getHex(),u=new x(n,s);u.position.copy(this.getObject3d().position),u._colorIndex=c,this.setPickObject3d(u)},e.identify=function(){return this.picked},e.setSymbol=function(t){var e,n,r;return t&&t instanceof ht.Material&&(t.needsUpdate=!0,n=(e=this.getMap().getSize()).width,r=e.height,t.resolution.set(n,r),this.getObject3d().material=t),this},t}(p),Ne={altitude:0,colors:null},Qe=function(A){function t(t,e,n,r){var i;Array.isArray(t)||(t=[t]);for(var o=[],a=t.length,s=0;s<a;s++){var c=t[s];o.push(wt(c)?jt(c):c.getCenter())}var u=Vt(o);e=ut.Util.extend({},Ne,e,{layer:r,lineStrings:t,coordinate:u});for(var h=[],l=0,f=[],d=[],v=0,p=[],g=0;g<a;g++){for(var x=At(t[g],r,u).positionsV,y=0,m=x.length;y<m;y++){var b=x[y];0<y&&y<m-1&&p.push(b.x,b.y,b.z),p.push(b.x,b.y,b.z)}var _=x.length+x.length-2,w=_;f[g]=[l,l+w],l+=w,d[g]={position:{count:_,start:v,end:v+3*_},instanceStart:{count:_,start:v,end:v+3*_},instanceEnd:{count:_,start:v,end:v+3*_},hide:!1},v+=3*_}(i=A.call(this)||this)._initOptions(e);var M=new C;M.setPositions(p),i._setMaterialRes(r,n),i._createLine2(M,n);var j=e.altitude,O=r.distanceToVector3(j,j).x,S=r.coordinateToVector3(u,O);return i.getObject3d().position.copy(S),i._faceMap=f,i._baseObjects=h,i._datas=t,i._geometriesAttributes=d,i.faceIndex=null,i.index=null,i._geometryCache=new C,i._geometryCache.setPositions(p),i._colorMap={},i.isHide=!1,i._initBaseObjectsEvent(h),i._setPickObject3d(p,n.linewidth),i._init(),i}i(t,A);var e=t.prototype;return e._init=function(){var t=this,e=this.getLayer().getPick();this.on("add",function(){e.add(t.pickObject3d)}),this.on("remove",function(){e.remove(t.pickObject3d)})},e._setMaterialRes=function(t,e){var n=t.getMap().getSize(),r=n.width,i=n.height;e.resolution.set(r,i)},e._setPickObject3d=function(t,e){var n=new C;n.setPositions(t);for(var r=this.getLayer().getPick(),i=this._geometriesAttributes,o=[],a=0,s=i.length;a<s;a++){var c=r.getColor(),u=c.getHex(),h=i[this._colorMap[u]=a].position.count;this._datas[a].colorIndex=u;for(var l=0;l<h;l++)o.push(c.r,c.g,c.b)}n.setColors(o);var f=new g({color:"#fff",linewidth:e,vertexColors:ht.VertexColors});this._setMaterialRes(this.getLayer(),f);var d=r.getColor().getHex(),v=new x(n,f);v.position.copy(this.getObject3d().position),v._colorIndex=d,this.setPickObject3d(v)},e.identify=function(){return this.picked},e.setSymbol=function(t){var e,n,r;return t&&t instanceof ht.Material&&(t.needsUpdate=!0,n=(e=this.getMap().getSize()).width,r=e.height,t.resolution.set(n,r),this.getObject3d().material=t),this},e.getSelectMesh=function(){var t,e,n=this._getIndex();if(null!=n)return this._baseObjects[n]||(t=this._datas[n],e=ut.Util.extend({},this.getOptions(),{index:n},wt(t)?t.properties:t.getProperties()),this._baseObjects[n]=new Ke(t,e,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[n])),{data:this._datas[n],baseObject:this._baseObjects[n]}},e._getIndex=function(t){return null==t&&(t=this.faceIndex||this.index),t},e._updateAttribute=function(t,e){for(var n=this._getHideGeometryIndex(e).indexs,r=this._geometryCache.attributes[e].array,i=r.length,o=0;o<i;o++)t.array[o]=r[o];for(var a=0;a<n.length;a++)for(var s=n[a],c=this._geometriesAttributes[s][e],u=c.start,h=c.end,l=u;l<h;l++)t.array[l]=-1e5;return this},e._showGeometry=function(t,e){var n;if(t&&(n=t.getOptions().index),null!=n){var r=this._geometriesAttributes[n];if(r.hide===e)return this;r.hide=e;var i=this.getObject3d().geometry;this._updateAttribute(i.attributes.instanceStart,"instanceStart"),this._updateAttribute(i.attributes.instanceEnd,"instanceEnd"),i.attributes.instanceStart.data.needsUpdate=!0,i.attributes.instanceEnd.data.needsUpdate=!0,this.isHide=e}return this},t}(Qt(p)),Xe=Math.PI/180,Ye=[[4e3,220],[2e3,100],[1e3,30],[500,15],[100,5],[50,2],[10,1],[5,.7],[2,.1],[1,.05],[.5,.02]],Je=["mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"],$e=new ht.Matrix4,tn=function(t){function e(){return t.apply(this,arguments)||this}i(e,t);var n=e.prototype;return n.draw=function(){this.renderScene()},n.drawOnInteracting=function(){this.renderScene()},n.coordinateToVector3=function(t,e){void 0===e&&(e=0);var n=this.getMap();if(!n)return null;t instanceof ut.Coordinate||(t=new ut.Coordinate(t));var r=n.coordinateToPoint(t,nn(n));return new ht.Vector3(r.x,r.y,e)},n.distanceToVector3=function(t,e,n){var r=this.getMap(),i=nn(r),o=n||r.getCenter();o instanceof ut.Coordinate||(o=new ut.Coordinate(o));var a=r.locate(o,t,e),s=r.coordinateToPoint(o,i),c=r.coordinateToPoint(a,i),u=Math.abs(c.x-s.x)*ut.Util.sign(t),h=Math.abs(c.y-s.y)*ut.Util.sign(e);return new ht.Vector3(u,h,0)},n.toShape=function(t){var n=this;if(!t)return null;if(t instanceof ut.MultiPolygon)return t.getGeometries().map(function(t){return n.toShape(t)});var e=t.getCenter(),r=this.coordinateToVector3(e),i=t.getShell().map(function(t){return n.coordinateToVector3(t).sub(r)}),o=new ht.Shape(i),a=t.getHoles();return a&&0<a.length&&(o.holes=a.map(function(t){var e=t.map(function(t){return n.coordinateToVector3(t).sub(r)});return new ht.Shape(e)})),o},n.toExtrudeMesh=function(t,e,n,r){var i=this;if(!t)return null;if(t instanceof ut.MultiPolygon)return t.getGeometries().map(function(t){return i.toExtrudeMesh(t,e,n,r)});var o=t.getCoordinates();o.forEach(function(t){for(var e=t.length-1;1<=e;e--)t[e].equals(t[e-1])&&t.splice(e,1)}),t.setCoordinates(o);var a=this.toShape(t),s=this.coordinateToVector3(t.getCenter());r=ut.Util.isNumber(r)?r:e,r=this.distanceToVector3(r,r).x;var c=this.distanceToVector3(e,e).x,u={bevelEnabled:!1,bevelSize:1};u[93<=parseInt(ht.REVISION)?"depth":"amount"]=r;var h=new ht.ExtrudeGeometry(a,u),l=new ht.BufferGeometry;l.fromGeometry(h);var f=new ht.Mesh(l,n);return f.position.set(s.x,s.y,c-r),f},n.toExtrudePolygon=function(t,e,n){return new Ft(t,e,n,this)},n.toBar=function(t,e,n){return new Z(t,e,n,this)},n.toLine=function(t,e,n){return new Bt(t,e,n,this)},n.toExtrudeLine=function(t,e,n){return new It(t,e,n,this)},n.toModel=function(t,e){return new Gt(t,e,this)},n.toExtrudeLineTrail=function(t,e,n){return new $t(t,e,n,this)},n.toExtrudePolygons=function(t,e,n){return new re(t,e,n,this)},n.toPoint=function(t,e,n){return new se(t,e,n,this)},n.toPoints=function(t,e,n){return new fe(t,e,n,this)},n.toBars=function(t,e,n){return new ve(t,e,n,this)},n.toExtrudeLines=function(t,e,n){return new ge(t,e,n,this)},n.toLines=function(t,e,n){return new ye(t,e,n,this)},n.toThreeVectorTileLayer=function(t,e,n){return new Ae(t,e,n,this)},n.toTerrain=function(t,e,n){return new Ie(t,e,n,this)},n.toTerrainVectorTileLayer=function(t,e,n){return new Le(t,e,n,this)},n.toHeatMap=function(t,e,n){return new Ge(t,e,n,this)},n.toFatLine=function(t,e,n){return new Ke(t,e,n,this)},n.toFatLines=function(t,e,n){return new Qe(t,e,n,this)},n.clearMesh=function(){var t=this.getScene();if(!t)return this;for(var e=t.children.length-1;0<=e;e--)t.children[e]instanceof ht.Mesh&&t.remove(t.children[e]);return this},n.lookAt=function(t){var e=this._getRenderer();return e&&e.context.lookAt(t),this},n.getCamera=function(){var t=this._getRenderer();return t?t.camera:null},n.getScene=function(){var t=this._getRenderer();return t?t.scene:null},n.renderScene=function(){var t=this._getRenderer();return t&&(t.clearCanvas(),t.renderScene()),this},n.renderPickScene=function(){var t,e=this._getRenderer();return!e||(t=e.pick)&&t.pick(this._containerPoint),this},n.getThreeRenderer=function(){var t=this._getRenderer();return t?t.context:null},n.getPick=function(){var t=this._getRenderer();return t?t.pick:null},n.addMesh=function(t,e){var n=this;if(void 0===e&&(e=!0),!t)return this;Array.isArray(t)||(t=[t]);var r=this.getScene();return t.forEach(function(t){t instanceof p?(r.add(t.getObject3d()),t.isAdd||(t.isAdd=!0,t._fire("add",{target:t})),t._animation&&ut.Util.isFunction(t._animation)&&(n._animationBaseObjectMap[t.getObject3d().uuid]=t)):t instanceof ht.Object3D&&r.add(t)}),this._zoomend(),e&&this.renderScene(),this},n.removeMesh=function(t,e){var n=this;if(void 0===e&&(e=!0),!t)return this;Array.isArray(t)||(t=[t]);var r=this.getScene();return t.forEach(function(t){t instanceof p?(r.remove(t.getObject3d()),t.isAdd&&(t.isAdd=!1,t._fire("remove",{target:t})),t._animation&&ut.Util.isFunction(t._animation)&&delete n._animationBaseObjectMap[t.getObject3d().uuid]):t instanceof ht.Object3D&&r.remove(t)}),e&&this.renderScene(),this},n._initRaycaster=function(){return this._raycaster||(this._raycaster=new ht.Raycaster,this._mouse=new ht.Vector2),this},n.identify=function(e,t){var r=this;if(!e)return console.error("coordinate is null,it should be Coordinate"),[];if(Array.isArray(e)&&(e=new ut.Coordinate(e)),!(e instanceof ut.Coordinate))return console.error("coordinate type is error,it should be Coordinate"),[];var n=this.getMap().coordToContainerPoint(e),i=(this._containerPoint=n).x,o=n.y;this._initRaycaster();var a=this._raycaster,s=this._mouse,c=this.getCamera(),u=this.getScene(),h=this.getMap().getSize();if(!u)return[];var l,f,d=h.width,v=h.height;s.x=i/d*2-1,s.y=-o/v*2+1,a.setFromCamera(s,c),l=a,f=this._getLinePrecision(this.getMap().getResolution()),113<b?l.params.Line.threshold=f:l.linePrecision=f;var p=[],g=[];u.children.forEach(function(t){var e=t.__parent;e&&e.getOptions?e.getOptions().interactive&&e.isVisible()&&(e.identify&&ut.Util.isFunction(e.identify)?g.push(e):p.push(t)):(t instanceof ht.Mesh||t instanceof ht.Group)&&p.push(t)});var x=[],y=a.intersectObjects(p,!0);y&&Array.isArray(y)&&y.length&&(x=y.map(function(t){var e=t.object,n=(e=r._recursionMesh(e)).__parent||e;return n.faceIndex=t.faceIndex,n.index=t.index,n})),this.renderPickScene(),g.length&&g.forEach(function(t){t.identify(e)&&x.push(t)});var m=(t=ut.Util.extend({},t)).count;return ut.Util.isNumber(m)&&0<m?x.slice(0,m):x},n._recursionMesh=function(t){for(;t&&!(t.parent instanceof ht.Scene);)t=t.parent;return t||{}},n._getLinePrecision=function(t){void 0===t&&(t=10);for(var e=0,n=Ye.length;e<n;e++){var r=Ye[e],i=r[0],o=r[1];if(i<t)return o}return.01},n._identifyBaseObjectEvents=function(n){if(!this.options.geometryEvents)return this;var t=this.map||this.getMap(),r=n.type,i=n.coordinate,e=ut.Util.now();if(this._mousemoveTimeOut&&"mousemove"===r&&e-this._mousemoveTimeOut<16)return this;this._mousemoveTimeOut=e,t.resetCursor("default");var o,a=this.identify(i),s=this.getScene();if(0===a.length&&s)for(var c=0,u=s.children.length;c<u;c++){var h=(s.children[c]||{}).__parent;h&&h.fire("empty",Object.assign({},n,{target:h}))}return"mousemove"===r?(a.length&&t.setCursor("pointer"),o=[],this._baseObjects&&this._baseObjects.forEach(function(e){var n=!0;a.forEach(function(t){e===t&&(n=!1)}),n&&o.push(e)}),o.forEach(function(t){t instanceof p&&(t.getSelectMesh?t.isHide||(t._mouseover=!1,t.fire("mouseout",Object.assign({},n,{target:t,type:"mouseout",selectMesh:null})),t.closeToolTip()):(t._mouseover=!1,t.fire("mouseout",Object.assign({},n,{target:t,type:"mouseout"})),t.closeToolTip()))}),a.forEach(function(t){var e;t instanceof p&&(t._mouseover||(t.fire("mouseover",Object.assign({},n,{target:t,type:"mouseover",selectMesh:t.getSelectMesh?t.getSelectMesh():null})),t._mouseover=!0),t.fire(r,Object.assign({},n,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),(e=t.getToolTip())&&!e._owner&&e.addTo(t),t.openToolTip(i))})):a.forEach(function(t){var e;t instanceof p&&(t.fire(r,Object.assign({},n,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),"click"===r&&((e=t.getInfoWindow())&&!e._owner&&e.addTo(t),t.openInfoWindow(i)))}),this._baseObjects=a,this},n._zoomend=function(){var i,t=this.getScene();t&&(i=this.getMap().getZoom(),t.children.forEach(function(t){var e,n,r=t.__parent;r&&r.getOptions&&(e=r.getMinZoom(),n=r.getMaxZoom(),i<e||n<i?(r.isVisible()&&(r.getObject3d().visible=!1),r._zoomVisible=!1):e<=i&&i<=n&&(r._visible&&(r.getObject3d().visible=!0),r._zoomVisible=!0))}))},n.onAdd=function(){var e=this;t.prototype.onAdd.call(this);var n=this.map||this.getMap();return n&&(Je.forEach(function(t){n.on(t,e._identifyBaseObjectEvents,e)}),this._needsUpdate=!0,this._animationBaseObjectMap||(this._animationBaseObjectMap={}),n.on("zooming zoomend",this._zoomend,this)),this},n.onRemove=function(){var e=this;t.prototype.onRemove.call(this);var n=this.map||this.getMap();return n&&(Je.forEach(function(t){n.off(t,e._identifyBaseObjectEvents,e)}),n.off("zooming zoomend",this._zoomend,this)),this},n._callbackBaseObjectAnimation=function(){if(this._animationBaseObjectMap)for(var t in this._animationBaseObjectMap){this._animationBaseObjectMap[t]._animation()}return this},n._getFovRatio=function(){var t=this.getMap().getFov();return Math.tan(t/2*Xe)},e}(ut.CanvasLayer);tn.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,geometryEvents:!0});var en=function(t){function e(){return t.apply(this,arguments)||this}i(e,t);var n=e.prototype;return n.getPrepareParams=function(){return[this.scene,this.camera]},n.getDrawParams=function(){return[this.scene,this.camera]},n._drawLayer=function(){t.prototype._drawLayer.apply(this,arguments)},n.hitDetect=function(){return!1},n.createCanvas=function(){t.prototype.createCanvas.call(this),this.createContext()},n.createContext=function(){var t;this.canvas.gl&&this.canvas.gl.wrap?this.gl=this.canvas.gl.wrap():((t=this.layer.options.glOptions||{alpha:!0,depth:!0,antialias:!0,stencil:!0}).preserveDrawingBuffer=!0,this.gl=this.gl||this._createGLContext(this.canvas,t)),this._initThreeRenderer(),this.layer.onCanvasCreate(this.context,this.scene,this.camera)},n._initThreeRenderer=function(){var t=new ht.WebGLRenderer({context:this.gl,alpha:!0});t.autoClear=!1,t.setClearColor(new ht.Color(1,1,1),0),t.setSize(this.canvas.width,this.canvas.height),t.clear(),t.canvas=this.canvas,this.context=t;var e=this.scene=new ht.Scene,n=this.layer.getMap(),r=n.getFov()*Math.PI/180,i=this.camera=new ht.PerspectiveCamera(r,n.width/n.height,n.cameraNear,n.cameraFar);i.matrixAutoUpdate=!1,this._syncCamera(),e.add(i),this.pick=new He(this.layer)},n.onCanvasCreate=function(){t.prototype.onCanvasCreate.call(this)},n.resizeCanvas=function(t){var e,n,r;this.canvas&&(e=t||this.getMap().getSize(),n=ut.Browser.retina?2:1,(r=this.canvas).height=n*e.height,r.width=n*e.width,this.context.setSize(r.width,r.height))},n.clearCanvas=function(){this.canvas&&this.context.clear()},n.prepareCanvas=function(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null},n.renderScene=function(){this.layer._callbackBaseObjectAnimation(),this._syncCamera(),this.context.render(this.scene,this.camera),this.completeRender()},n.remove=function(){delete this._drawContext,t.prototype.remove.call(this)},n._syncCamera=function(){var t=this.getMap(),e=this.camera;e.matrix.elements=t.cameraWorldMatrix,e.projectionMatrix.elements=t.projMatrix,e.projectionMatrixInverse.elements=$e.getInverse(e.projectionMatrix).elements},n._createGLContext=function(t,e){for(var n=["webgl","experimental-webgl"],r=null,i=0;i<n.length;++i){try{r=t.getContext(n[i],e)}catch(t){}if(r)break}return r},e}(ut.renderer.CanvasLayerRenderer);function nn(t){return t.getGLZoom()}tn.registerRenderer("gl",en),t.ThreeLayer=tn,t.ThreeRenderer=en,t.BaseObject=p,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.three v0.11.3, requires maptalks@>=0.39.0.")});
