/*!
 * maptalks.d3 v0.4.2
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
/*!
 * requires maptalks@>=0.25.0
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("d3")):"function"==typeof define&&define.amd?define(["exports","maptalks","d3"],e):e(t.maptalks=t.maptalks||{},t.maptalks,t.d3)}(this,function(t,e,r){"use strict";function o(t,e){for(var r=Object.getOwnPropertyNames(e),o=0;o<r.length;o++){var n=r[o],i=Object.getOwnPropertyDescriptor(e,n);i&&i.configurable&&void 0===t[n]&&Object.defineProperty(t,n,i)}return t}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function s(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):o(t,e))}function a(){var t="http://www.w3.org/2000/svg",e=document.createElementNS(t,"svg");e.style.overflow="",e.style.position="absolute",e.setAttribute("xmlns",t);var r=document.createElementNS(t,"defs");return e.appendChild(r),e.defs=r,e}var h=e.DomUtil.TRANSFORM,p={d3Version:4,container:"front",renderer:"canvas",hideWhenZooming:!1},d=function(t){function e(r,o){return n(this,e),i(this,t.call(this,r,o))}return s(e,t),e.prototype.isCanvasRender=function(){return"canvas"===this.options.renderer},e.prototype.prepareToDraw=function(){return null},e.prototype.draw=function(){return this},e.prototype.redraw=function(){return this.isCanvasRender()&&this._getRenderer().setToRedraw(),this},e.prototype.getContext=function(){return this._getRenderer().context},e.prototype.getGeoProjection=function(){return this._getRenderer().getGeoProjection()},e}(e.Layer);d.mergeOptions(p),d.registerRenderer("dom",function(){function t(e){n(this,t),this.layer=e,this._initContainer()}return t.prototype.getMap=function(){return this.layer.getMap()},t.prototype.needToRedraw=function(){var t=this.getMap(),e=t._getRenderer();return t.isInteracting()||e&&(e.isStateChanged&&e.isStateChanged()||e.isViewChanged&&e.isViewChanged())},t.prototype.render=function(){if(this._predrawn||(this._drawContext=this.layer.prepareToDraw(this.context,this.layer.getGeoProjection()),this._drawContext||(this._drawContext=[]),Array.isArray(this._drawContext)||(this._drawContext=[this._drawContext]),this._predrawn=!0),!this._drawed){var t=[this.layer.getContext(),this.layer.getGeoProjection()].concat(this._drawContext);this.layer.draw.apply(this.layer,t),this._drawed=!0}return this._refreshViewBox(),this.layer.fire("layerload"),!0},t.prototype.drawOnInteracting=function(t){var r=this.getMap();r.isZooming()&&"none"!==this._layerContainer.style.display&&t&&t.matrix?e.DomUtil.setTransformMatrix(this._layerContainer,t.matrix.container):r.isMoving()&&!r.getPitch()||this._refreshViewBox()},t.prototype.setZIndex=function(t){this._zIndex=t,this._layerContainer.style.zIndex=100+t},t.prototype.getEvents=function(){return{zoomend:this.onZoomEnd,zoomstart:this.onZoomStart,moveend:this._refreshViewBox}},t.prototype.onZoomEnd=function(){this._resetContainer(),(this.layer.options.hideWhenZooming||!this._canTransform()||this.getMap().domCssMatrix)&&(this._layerContainer.style.display="")},t.prototype.onZoomStart=function(){(this.layer.options.hideWhenZooming||!this._canTransform()||this.getMap().domCssMatrix)&&(this._layerContainer.style.display="none")},t.prototype.getGeoProjection=function(){var t=this.getMap();this._d3zoom||(this._d3zoom=t.getZoom());var o=this,n=this.layer.options.d3Version,i=function(r,n){r[0]&&r[1]&&(r=[r[0],r[1]]);var i=t.coordinateToPoint(new e.Coordinate(r,n),o._d3zoom);return this&&this.stream&&this.stream.point(i.x,i.y),[i.x,i.y]};return 3===n?i:4===n?r.geoTransform({point:i}):null},t.prototype.remove=function(){delete this.context,e.DomUtil.removeDomNode(this._layerContainer),delete this._layerContainer,delete this._viewBox,delete this._d3zoom,delete this.layer},t.prototype._canTransform=function(){return e.Browser.any3d||e.Browser.ie9},t.prototype._getContainerPos=function(){var t=this.getMap(),e=t.getCenter(),r=this._d3zoom||t.getZoom();return[t.coordinateToPoint(e,r),1]},t.prototype._initContainer=function(){var t=this.getMap();this._layerContainer=e.DomUtil.createElOn("div","position:absolute;left:0px;top:0px;"),this.context=a(),this._layerContainer.appendChild(this.context),this._resetContainer(),("front"===this.layer.options.container?t._panels.frontLayer:t._panels.backLayer).appendChild(this._layerContainer)},t.prototype._resetContainer=function(){this.context.style.transform="",this._refreshViewBox()},t.prototype._refreshViewBox=function(){var t=this.getMap(),r=t.getSize(),o=t._getResolution(),n=this._d3zoom||t.getZoom(),i=o/t._getResolution(n);this.context.setAttribute("width",r.width),this.context.setAttribute("height",r.height);var s=t.coordinateToPoint(t.getCenter(),n);this._viewBox=[s.x-r.width*i/2,s.y-r.height*i/2,r.width*i,r.height*i],this.context.setAttribute("viewBox",this._viewBox.join(" "));var a=this._layerContainer;if(a.style.transform="",t.domCssMatrix){var p=t.getSize();parseInt(a.style.width)===p.width&&parseInt(a.style.height)===p.height||(a.style.width=p.width+"px",a.style.height=p.height+"px");var d=e.Util.join(t.domCssMatrix);a.style[h]="matrix3D("+d+")"}else e.DomUtil.removeTransform(a),(a.style.width||a.style.height)&&(a.style.width=null,a.style.height=null);var l=t.offsetPlatform();a.style.left=-l.x+"px",a.style.top=-l.y+"px"},t}()),d.registerRenderer("canvas",function(t){function o(){return n(this,o),i(this,t.apply(this,arguments))}return s(o,t),o.prototype.remove=function(){delete this._drawContext,t.prototype.remove.call(this)},o.prototype.getGeoProjection=function(){var t=this.getMap(),o=function(r,o){r[0]&&r[1]&&(r=[r[0],r[1]]);var n=t.coordinateToContainerPoint(new e.Coordinate(r,o));return this&&this.stream&&this.stream.point(n.x,n.y),[n.x,n.y]},n=this.layer.options.d3Version;return 3===n?o:4===n?r.geoTransform({point:o}):null},o.prototype.draw=function(){this.prepareCanvas(),this._predrawn||(this._armContext(),this._drawContext=this.layer.prepareToDraw(this.context,this.layer.getGeoProjection()),this._drawContext||(this._drawContext=[]),Array.isArray(this._drawContext)||(this._drawContext=[this._drawContext]),this._predrawn=!0),this.layer.draw.apply(this.layer,[this.context,this.layer.getGeoProjection()].concat(this._drawContext)),this.completeRender()},o.prototype.drawOnInteracting=function(){this.draw()},o.prototype._armContext=function(){if(this.context){var t=this.getMap();this.context.arcInMeter=function(e,r,o,n,i,s){var a=t.distanceToPixel(o,0);return this.arc(e,r,a.width,n,i,s)},this.context.arcToInMeter=function(e,r,o,n,i){var s=t.distanceToPixel(i,0);return this.arcTo(e,r,o,n,s.width)},this.context.ellipse&&(this.context.ellispeInMeter=function(e,r,o,n,i,s,a,h){var p=t.distanceToPixel(o,n);return this.ellipse(e,r,p.width,p.height,i,s,a,h)}),this.context.rectInMeter=function(e,r,o,n){var i=t.distanceToPixel(o,n);return this.rect(e,r,i.width,i.height)}}},o}(e.renderer.CanvasRenderer)),t.D3Layer=d,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.d3 v0.4.2, requires maptalks@>=0.25.0.")});